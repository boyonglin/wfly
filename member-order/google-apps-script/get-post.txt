// Google Apps Script 範例：貼到試算表的 Apps Script 編輯器
// 完成後「部署為網路應用程式」，權限設任何人可存取
//
// 【安全性設定】
// 1. 到「設定」(齒輪圖示) > 「腳本屬性」
// 2. 新增屬性：GOOGLE_SHEET_ID = 你的試算表 ID

function doGet(e) {
  return ContentService.createTextOutput(
    JSON.stringify({ status: 'ok', message: 'Apps Script is running' })
  ).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    Logger.log('Received POST data: ' + JSON.stringify(e));

    if (!e || !e.postData || !e.postData.contents) {
      throw new Error('No POST data received');
    }

    const data = JSON.parse(e.postData.contents);
    Logger.log('Parsed data: ' + JSON.stringify(data));

    // 【安全性】從腳本屬性取得 Sheet ID，不再從前端接收
    const props = PropertiesService.getScriptProperties();
    const sheetId = props.getProperty('GOOGLE_SHEET_ID');

    if (!sheetId) {
      Logger.log('Server configuration error: Missing GOOGLE_SHEET_ID in script properties');
      throw new Error('Server configuration error');
    }

    const ss = SpreadsheetApp.openById(sheetId);
    const sheet = ss.getSheets()[0];

    // =============================================
    // 處理付款狀態更新請求
    // =============================================
    if (data.action === 'updatePaymentStatus' && data.orderId) {
      const lastRow = sheet.getLastRow();
      if (lastRow > 1) {
        const orderIdColumn = sheet.getRange(2, 2, lastRow - 1, 1).getValues(); // B欄是 orderId
        for (let i = 0; i < orderIdColumn.length; i++) {
          if (orderIdColumn[i][0] === data.orderId) {
            const foundRow = i + 2;
            // V欄 (第22欄) 是付款狀態
            const paymentStatusText = data.paymentStatus === 'paid' ? '已付款' : '';
            sheet.getRange(foundRow, 22).setValue(paymentStatusText);
            Logger.log('Updated payment status for order ' + data.orderId + ' at row ' + foundRow);
            return ContentService.createTextOutput(
              JSON.stringify({ status: 'ok', action: 'paymentStatusUpdated', row: foundRow })
            ).setMimeType(ContentService.MimeType.JSON);
          }
        }
      }
      // 找不到訂單
      return ContentService.createTextOutput(
        JSON.stringify({ status: 'error', message: 'Order not found: ' + data.orderId })
      ).setMimeType(ContentService.MimeType.JSON);
    }

    // =============================================
    // 處理新增/更新訂單請求
    // =============================================
    const itemsText = data.itemsSummary || JSON.stringify(data.items);

    // 付款方式處理：bank → 銀行轉帳, linepay → LINE Pay，否則空值
    const paymentMethodText = data.paymentMethod === 'bank' ? '銀行轉帳' :
                              data.paymentMethod === 'linepay' ? 'LINE Pay' : '';
    // 付款狀態處理：只有 paid 才顯示「已付款」，否則空值
    const paymentStatusText = data.paymentStatus === 'paid' ? '已付款' : '';

    // 準備要寫入的資料列
    const rowData = [
      new Date(),
      data.orderId,
      data.consultantName,
      data.consultantId,
      data.consultantLocation,
      data.customerName,
      data.customerPhone,
      data.customerEmail,
      data.customerBirthday,
      data.customerAddress,
      data.customerCompany,
      data.customerTaxId,
      data.customerSource,
      data.customerNotes,
      data.customerAppointmentDate,
      data.customerAppointmentPeriod,
      data.customerAppointmentTime,
      itemsText,
      data.total,
      data.signature,
      paymentMethodText,   // 付款方式（銀行轉帳 / LINE Pay / 空值）
      paymentStatusText    // 付款狀態（已付款 / 空值）
    ];

    // 如果是更新模式，找到原訂單並覆寫
    if (data.isUpdate && data.orderId) {
      const lastRow = sheet.getLastRow();
      let foundRow = -1;

      // 從第2列開始搜尋 (第1列是標題)
      if (lastRow > 1) {
        const orderIdColumn = sheet.getRange(2, 2, lastRow - 1, 1).getValues(); // B欄是 orderId
        for (let i = 0; i < orderIdColumn.length; i++) {
          if (orderIdColumn[i][0] === data.orderId) {
            foundRow = i + 2; // +2 因為陣列從0開始，且跳過標題列
            break;
          }
        }
      }

      if (foundRow > 0) {
        // 找到原訂單，覆寫該行
        sheet.getRange(foundRow, 1, 1, rowData.length).setValues([rowData]);
        Logger.log('Updated existing order at row: ' + foundRow);
        return ContentService.createTextOutput(
          JSON.stringify({ status: 'ok', action: 'updated', row: foundRow })
        ).setMimeType(ContentService.MimeType.JSON);
      }
    }

    // 新增一筆訂單
    sheet.appendRow(rowData);

    return ContentService.createTextOutput(
      JSON.stringify({ status: 'ok', action: 'created' })
    ).setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    Logger.log('Error: ' + err.message);
    return ContentService.createTextOutput(
      JSON.stringify({ status: 'error', message: err.message })
    ).setMimeType(ContentService.MimeType.JSON);
  }
}
