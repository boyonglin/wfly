// =============================================
// LINE Pay API 串接 - Google Apps Script
// =============================================
// 使用前請先設定腳本屬性：
// 1. LINEPAY_CHANNEL_ID - Channel ID
// 2. LINEPAY_CHANNEL_SECRET - Channel Secret Key
//
// 取得方式：
// 合作商店中心 > 開發者工具 > 管理連結金鑰
// https://pay.line.me/portal/tw/auth/login
// =============================================

/**
 * LINE Pay 設定
 * @param {boolean} isSandbox - 是否使用 Sandbox 環境（由前端傳入）
 */
function getLinePayConfig(isSandbox) {
  const props = PropertiesService.getScriptProperties();

  // ⚠️ 用 trim() 去除可能的空白
  const channelId = (props.getProperty('LINEPAY_CHANNEL_ID') || '').trim();
  const channelSecret = (props.getProperty('LINEPAY_CHANNEL_SECRET') || '').trim();

  return {
    channelId: channelId,
    channelSecret: channelSecret,
    apiUrl: isSandbox
      ? 'https://sandbox-api-pay.line.me'
      : 'https://api-pay.line.me',
    isSandbox: isSandbox
  };
}

/**
 * 產生 LINE Pay API 簽章
 * LINE Pay API 簽章格式（參考官方文件）：
 * MAC = HMAC-SHA256(encode(ChannelSecret), encode(ChannelSecret + apiPath + RequestBody + Nonce))
 * Signature = Base64(MAC)
 *
 * 重點：key 和 message 都要先轉成 byte array！
 */
function generateLinePaySignature(channelSecret, uri, requestBody, nonce) {
  // 組合訊息：ChannelSecret + URI + RequestBody + Nonce
  const message = channelSecret + uri + requestBody + nonce;

  // ⚠️ 重點：將字串轉換為 byte array（模擬 TextEncoder.encode()）
  const keyBytes = Utilities.newBlob(channelSecret).getBytes();
  const messageBytes = Utilities.newBlob(message).getBytes();

  // 使用 byte array 版本的 HMAC-SHA256
  const signatureBytes = Utilities.computeHmacSha256Signature(messageBytes, keyBytes);

  // 轉換為 Base64
  const signature = Utilities.base64Encode(signatureBytes);

  return signature;
}

/**
 * LINE Pay Request API - 建立付款請求
 * @param {string} orderId - 訂單編號
 * @param {number} amount - 金額
 * @param {string} productName - 商品名稱
 * @param {string} confirmUrl - 付款成功後導回的網址
 * @param {string} cancelUrl - 取消付款後導回的網址
 * @param {boolean} sandbox - 是否使用 Sandbox 環境
 */
function linePayRequest(orderId, amount, productName, confirmUrl, cancelUrl, sandbox) {
  const config = getLinePayConfig(sandbox);
  const uri = '/v3/payments/request';
  const nonce = Utilities.getUuid();

  // 建立請求資料物件
  const requestData = {
    amount: amount,
    currency: 'TWD',
    orderId: orderId,
    packages: [{
      id: 'pkg_' + orderId,
      amount: amount,
      name: '吾飛藝術銀行',
      products: [{
        name: productName,
        quantity: 1,
        price: amount
      }]
    }],
    redirectUrls: {
      confirmUrl: confirmUrl,
      cancelUrl: cancelUrl
    }
  };

  // ⚠️ 重要：簽章和 payload 必須用完全相同的 JSON 字串
  const requestBody = JSON.stringify(requestData);
  const signature = generateLinePaySignature(config.channelSecret, uri, requestBody, nonce);

  const options = {
    method: 'post',
    contentType: 'application/json',
    headers: {
      'X-LINE-ChannelId': config.channelId,
      'X-LINE-Authorization-Nonce': nonce,
      'X-LINE-Authorization': signature
    },
    payload: requestBody,
    muteHttpExceptions: true
  };

  try {
    const response = UrlFetchApp.fetch(config.apiUrl + uri, options);
    const responseText = response.getContentText();
    const result = JSON.parse(responseText);

    if (result.returnCode === '0000') {
      return {
        success: true,
        transactionId: String(result.info.transactionId),
        paymentUrl: result.info.paymentUrl.web
      };
    } else {
      return {
        success: false,
        error: result.returnMessage,
        code: result.returnCode
      };
    }
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

/**
 * LINE Pay Confirm API - 確認付款
 * @param {string} transactionId - LINE Pay 交易 ID
 * @param {number} amount - 金額（必須與 Request 時相同）
 * @param {boolean} sandbox - 是否使用 Sandbox 環境
 */
function linePayConfirm(transactionId, amount, sandbox) {
  const config = getLinePayConfig(sandbox);
  const uri = '/v3/payments/' + transactionId + '/confirm';
  const nonce = Utilities.getUuid();

  const requestBody = JSON.stringify({
    amount: amount,
    currency: 'TWD'
  });

  const signature = generateLinePaySignature(config.channelSecret, uri, requestBody, nonce);

  const options = {
    method: 'post',
    contentType: 'application/json',
    headers: {
      'X-LINE-ChannelId': config.channelId,
      'X-LINE-Authorization-Nonce': nonce,
      'X-LINE-Authorization': signature
    },
    payload: requestBody,
    muteHttpExceptions: true
  };

  try {
    const response = UrlFetchApp.fetch(config.apiUrl + uri, options);
    const result = JSON.parse(response.getContentText());

    if (result.returnCode === '0000') {
      return {
        success: true,
        transactionId: transactionId,
        info: result.info
      };
    } else {
      return {
        success: false,
        error: result.returnMessage,
        code: result.returnCode
      };
    }
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

// =============================================
// doGet 處理 LINE Pay API 請求
// =============================================

function doGet(e) {
  const action = e.parameter.action;
  const data = e.parameter.data ? JSON.parse(Utilities.newBlob(Utilities.base64Decode(e.parameter.data)).getDataAsString()) : {};

  // LINE Pay 建立付款請求
  if (action === 'linePayRequest') {
    const { orderId, amount, productName, confirmUrl, cancelUrl, sandbox } = data;
    const result = linePayRequest(orderId, amount, productName, confirmUrl, cancelUrl, sandbox);
    return ContentService.createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
  }

  // LINE Pay 確認付款
  if (action === 'linePayConfirm') {
    const { transactionId, amount, sandbox } = data;
    const result = linePayConfirm(transactionId, amount, sandbox);
    return ContentService.createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
  }

  return ContentService.createTextOutput(JSON.stringify({
    status: 'ok',
    message: 'LINE Pay API is running',
    usage: 'GET ?action=linePayRequest|linePayConfirm&data=BASE64_ENCODED_JSON'
  })).setMimeType(ContentService.MimeType.JSON);
}
