<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>吾飛藝術銀行 - 會員服務訂購單</title>

    <!-- 0. Preconnect 優化第三方資源載入 -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://esm.sh">
    <link rel="preconnect" href="https://script.google.com">
    <link rel="dns-prefetch" href="https://cdn.tailwindcss.com">
    <link rel="dns-prefetch" href="https://unpkg.com">
    <link rel="dns-prefetch" href="https://esm.sh">

    <!-- 1. 引入 Tailwind CSS (樣式框架) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. Google Fonts for Calendar -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- 3. 引入 Babel (用於瀏覽器端編譯 React JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. 引入自訂樣式 -->
    <link rel="stylesheet" href="styles.css">

    <!-- 5. 引入設定檔 (必須在 React 之前載入) -->
    <script src="config.js"></script>
</head>
<body class="bg-[#f5f5f7]">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // =============================================
        // 引入 React 與 Lucide 圖標庫
        // =============================================
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import {
            ChevronDown, Check, Send, User, Info, Plus, Minus, Sparkles, Heart,
            Briefcase, Network, PenTool, Eraser, X, Edit3, Loader2, ShieldCheck, Save, Trash2
        } from 'https://esm.sh/lucide-react@0.263.1';

        // =============================================
        // 從全域設定取得常數
        // =============================================
        const { GOOGLE_SCRIPT_URL, STORAGE_KEY, DRAFT_KEY, LOCATIONS, DEFAULT_LOCATION, PAYMENT, ORDER_ID_PREFIX, CALENDAR, LINE } = window.APP_CONFIG;

        // Icon 映射表
        const ICON_MAP = {
            Sparkles: Sparkles,
            User: User,
            Heart: Heart,
            Briefcase: Briefcase,
            Network: Network
        };

        // 將產品資料轉換為包含實際 icon 元件的版本
        const initialProducts = window.APP_PRODUCTS.map(product => ({
            ...product,
            icon: React.createElement(ICON_MAP[product.iconName], { className: "w-8 h-8" })
        }));

        // =============================================
        // 訂單填寫表單元件
        // =============================================
        const OrderFormPage = () => {
            // =============================================
            // 狀態管理
            // =============================================
            const [consultantInfo, setConsultantInfo] = useState({ name: '', id: '', location: DEFAULT_LOCATION });
            const [customerInfo, setCustomerInfo] = useState({
                name: '', phone: '', birthday: '', email: '',
                address: '', company: '', taxId: '', source: '', notes: '',
                appointmentDate: '', appointmentTime: '', appointmentPeriod: 'morning'
            });
            const [errors, setErrors] = useState({});
            const [expandedCards, setExpandedCards] = useState({});
            const [cart, setCart] = useState({});
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [scrolled, setScrolled] = useState(false);

            // 簽名板相關
            const [showSignatureModal, setShowSignatureModal] = useState(false);
            const [signatureData, setSignatureData] = useState(null);
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);
            const [modalHasSignature, setModalHasSignature] = useState(false);

            // 編輯模式 - 保留原訂單編號
            const [editingOrderId, setEditingOrderId] = useState(null);

            // 自定義下拉選單狀態
            const [showPeriodDropdown, setShowPeriodDropdown] = useState(false);
            const [showTimeDropdown, setShowTimeDropdown] = useState(false);
            const periodRef = useRef(null);
            const timeRef = useRef(null);

            // 自定義行事曆狀態
            const [calendarEvents, setCalendarEvents] = useState([]);
            const [calendarLoading, setCalendarLoading] = useState(true);
            const [calendarError, setCalendarError] = useState('');
            const [calendarMonth, setCalendarMonth] = useState(new Date());

            // 日期輔助函數
            const getDaysInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDayOfWeek = firstDay.getDay();

                const days = [];
                // 填充前面的空白
                for (let i = 0; i < startingDayOfWeek; i++) {
                    days.push(null);
                }
                // 填充實際日期
                for (let i = 1; i <= daysInMonth; i++) {
                    days.push(new Date(year, month, i));
                }
                return days;
            };

            const isSameDay = (date1, date2) => {
                if (!date1 || !date2) return false;
                return date1.getFullYear() === date2.getFullYear() &&
                       date1.getMonth() === date2.getMonth() &&
                       date1.getDate() === date2.getDate();
            };

            const isToday = (date) => {
                if (!date) return false;
                const today = new Date();
                return isSameDay(date, today);
            };

            const isPastDate = (date) => {
                if (!date) return false;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                return date < today;
            };

            const formatDateString = (date) => {
                if (!date) return '';
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            // =============================================
            // 自定義行事曆 - 透過 Apps Script 代理 Google Calendar
            // =============================================
            const fetchCalendarEvents = async (month) => {
                const endpoint = LINE?.PUSH_API_ENDPOINT;
                if (!endpoint) {
                    setCalendarError('尚未設定行事曆代理端點。');
                    setCalendarLoading(false);
                    return;
                }

                setCalendarLoading(true);
                try {
                    const year = month.getFullYear();
                    const m = month.getMonth();
                    const timeMin = new Date(year, m, 1).toISOString();
                    const timeMax = new Date(year, m + 1, 0, 23, 59, 59).toISOString();
                    const payload = btoa(JSON.stringify({ timeMin, timeMax }));
                    const url = `${endpoint}?action=getCalendarEvents&data=${encodeURIComponent(payload)}`;

                    const res = await fetch(url);
                    if (!res.ok) throw new Error('Calendar proxy 回應錯誤');
                    const data = await res.json();

                    if (!data.success) {
                        throw new Error(data.error || 'Calendar proxy 回應錯誤');
                    }

                    const events = (data.events || []).map(it => ({
                        id: it.id,
                        title: it.summary || '(無標題)',
                        start: it.start?.dateTime || it.start?.date,
                        end: it.end?.dateTime || it.end?.date,
                        allDay: Boolean(it.start?.date)
                    }));

                    setCalendarEvents(events);
                    setCalendarError('');
                } catch (err) {
                    console.error('GCAL 代理讀取失敗:', err);
                    setCalendarError('行事曆載入失敗，請稍後再試。');
                }
                setCalendarLoading(false);
            };

            useEffect(() => {
                fetchCalendarEvents(calendarMonth);
            }, [calendarMonth]);

            // 取得當月日期陣列（用於行事曆格線）
            const getCalendarDays = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDayOfWeek = firstDay.getDay();
                // 週一開始 (0=Mon, 6=Sun)
                const adjustedStart = startingDayOfWeek === 0 ? 6 : startingDayOfWeek - 1;
                const days = [];
                // 上月補空
                for (let i = 0; i < adjustedStart; i++) {
                    const prevDate = new Date(year, month, -adjustedStart + i + 1);
                    days.push({ date: prevDate, isCurrentMonth: false });
                }
                // 本月
                for (let i = 1; i <= daysInMonth; i++) {
                    days.push({ date: new Date(year, month, i), isCurrentMonth: true });
                }
                // 補滿至 42 格 (6 週)
                const remaining = 42 - days.length;
                for (let i = 1; i <= remaining; i++) {
                    days.push({ date: new Date(year, month + 1, i), isCurrentMonth: false });
                }
                return days;
            };

            // 取得某日的事件
            const getEventsForDay = (date) => {
                return calendarEvents.filter(ev => {
                    const evDate = new Date(ev.start);
                    return evDate.getFullYear() === date.getFullYear() &&
                           evDate.getMonth() === date.getMonth() &&
                           evDate.getDate() === date.getDate();
                });
            };

            // 格式化時間
            const formatEventTime = (dateStr) => {
                if (!dateStr || dateStr.length === 10) return ''; // 全天事件
                const d = new Date(dateStr);
                return d.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
            };

            // =============================================
            // 初始化 Effect - 載入草稿
            // =============================================
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const urlConsultant = {
                    name: params.get('c_name'),
                    id: params.get('c_id'),
                    location: params.get('loc')
                };

                // 檢查是否有已完成的訂單，若有則跳轉到成功頁
                try {
                    const savedOrder = localStorage.getItem(STORAGE_KEY);
                    if (savedOrder) {
                        const parsedOrder = JSON.parse(savedOrder);
                        if (parsedOrder.deadline && parsedOrder.deadline > Date.now()) {
                            window.location.href = 'order-success.html';
                            return;
                        } else {
                            localStorage.removeItem(STORAGE_KEY);
                        }
                    }
                } catch (error) {
                    console.error('Failed to check saved order:', error);
                    localStorage.removeItem(STORAGE_KEY);
                }

                // 載入草稿
                let draftLoaded = false;
                try {
                    const savedDraft = localStorage.getItem(DRAFT_KEY);
                    if (savedDraft) {
                        const draft = JSON.parse(savedDraft);
                        setConsultantInfo(prev => ({
                            name: urlConsultant.name || draft.consultantInfo?.name || prev.name,
                            id: urlConsultant.id || draft.consultantInfo?.id || prev.id,
                            location: urlConsultant.location || draft.consultantInfo?.location || prev.location
                        }));
                        if (draft.customerInfo) setCustomerInfo(draft.customerInfo);
                        if (draft.cart) setCart(draft.cart);
                        if (draft.signatureData) setSignatureData(draft.signatureData);
                        if (draft.editingOrderId) setEditingOrderId(draft.editingOrderId);  // 載入原訂單編號
                        draftLoaded = true;
                    }
                } catch (e) {
                    console.error("Draft load failed", e);
                }

                if (!draftLoaded) {
                    setConsultantInfo(prev => ({
                        name: urlConsultant.name || prev.name,
                        id: urlConsultant.id || prev.id,
                        location: urlConsultant.location || prev.location
                    }));
                }

                const handleScroll = () => {
                    setScrolled(window.scrollY > 20);
                    // 捲動時關閉所有下拉選單
                    setShowPeriodDropdown(false);
                    setShowTimeDropdown(false);
                };
                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            // =============================================
            // 自動儲存 Effect
            // =============================================
            useEffect(() => {
                const draftData = {
                    consultantInfo,
                    customerInfo,
                    cart,
                    signatureData,
                    editingOrderId,  // 保存編輯中的訂單編號
                    updatedAt: Date.now()
                };
                localStorage.setItem(DRAFT_KEY, JSON.stringify(draftData));
            }, [consultantInfo, customerInfo, cart, signatureData, editingOrderId]);

            // =============================================
            // 點擊外部關閉下拉選單
            // =============================================
            useEffect(() => {
                const handleClickOutside = (event) => {
                    // 檢查是否點擊在時段下拉選單區域內
                    const periodDropdown = document.querySelector('[data-dropdown="period"]');
                    const timeDropdown = document.querySelector('[data-dropdown="time"]');

                    const isInsidePeriodRef = periodRef.current?.contains(event.target);
                    const isInsidePeriodDropdown = periodDropdown?.contains(event.target);
                    const isInsideTimeRef = timeRef.current?.contains(event.target);
                    const isInsideTimeDropdown = timeDropdown?.contains(event.target);

                    if (showPeriodDropdown && !isInsidePeriodRef && !isInsidePeriodDropdown) {
                        setShowPeriodDropdown(false);
                    }
                    if (showTimeDropdown && !isInsideTimeRef && !isInsideTimeDropdown) {
                        setShowTimeDropdown(false);
                    }
                };

                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [showPeriodDropdown, showTimeDropdown]);

            // =============================================
            // 簽名板 Canvas Effects
            // =============================================
            useEffect(() => {
                if (showSignatureModal) {
                    document.body.style.overflow = 'hidden';
                    setTimeout(initCanvas, 100);
                } else {
                    document.body.style.overflow = '';
                }
            }, [showSignatureModal]);

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas || !showSignatureModal) return;

                const preventDefault = (e) => {
                   if(e.target === canvas) e.preventDefault();
                }

                canvas.addEventListener('touchmove', preventDefault, { passive: false });
                canvas.addEventListener('touchstart', preventDefault, { passive: false });
                canvas.addEventListener('touchend', preventDefault, { passive: false });

                return () => {
                    canvas.removeEventListener('touchmove', preventDefault);
                    canvas.removeEventListener('touchstart', preventDefault);
                    canvas.removeEventListener('touchend', preventDefault);
                };
            }, [showSignatureModal]);

            // =============================================
            // Canvas 繪圖函式
            // =============================================
            const initCanvas = () => {
                const canvas = canvasRef.current;
                if (canvas) {
                    const parent = canvas.parentElement;
                    canvas.width = parent.clientWidth;
                    canvas.height = parent.clientHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.lineWidth = 3;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.strokeStyle = '#000000';
                    setModalHasSignature(false);
                }
            };

            const getPoint = (e, canvas) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };

            const startDrawing = (e) => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const { x, y } = getPoint(e, canvas);
                const ctx = canvas.getContext('2d');
                ctx.beginPath();
                ctx.moveTo(x, y);
                setIsDrawing(true);
            };

            const draw = (e) => {
                if (!isDrawing) return;
                const canvas = canvasRef.current;
                if (!canvas) return;
                const { x, y } = getPoint(e, canvas);
                const ctx = canvas.getContext('2d');
                ctx.lineTo(x, y);
                ctx.stroke();
                if (!modalHasSignature) setModalHasSignature(true);
            };

            const stopDrawing = () => setIsDrawing(false);

            const clearCanvas = () => {
                const canvas = canvasRef.current;
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    setModalHasSignature(false);
                }
            };

            const confirmSignature = () => {
                const canvas = canvasRef.current;
                if (canvas && modalHasSignature) {
                    setSignatureData(canvas.toDataURL());
                    setShowSignatureModal(false);
                } else {
                    alert('請先進行簽名');
                }
            };

            // =============================================
            // 表單處理函式
            // =============================================
            const handleConsultantChange = (e) => {
                const { name, value } = e.target;
                setConsultantInfo(prev => ({ ...prev, [name]: value }));
                if (errors[`consultant_${name}`]) {
                    setErrors(prev => ({ ...prev, [`consultant_${name}`]: false }));
                }
            };

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                if (name === 'birthday') {
                    const numericValue = value.replace(/\D/g, '').slice(0, 8);
                    setCustomerInfo(prev => ({ ...prev, [name]: numericValue }));
                } else {
                    setCustomerInfo(prev => ({ ...prev, [name]: value }));
                }
                if (errors[`customer_${name}`]) {
                    setErrors(prev => ({ ...prev, [`customer_${name}`]: false }));
                }
            };

            const toggleExpand = (id) => setExpandedCards(prev => ({ ...prev, [id]: !prev[id] }));

            const updateQuantity = (id, delta) => {
                setCart(prev => {
                    const currentQty = prev[id] || 0;
                    const newQty = Math.max(0, currentQty + delta);
                    const newCart = { ...prev };
                    if (newQty === 0) delete newCart[id];
                    else newCart[id] = newQty;
                    return newCart;
                });
            };

            const calculateTotal = () => {
                return Object.entries(cart).reduce((total, [id, qty]) => {
                    const product = initialProducts.find(p => p.id === parseInt(id));
                    return total + (product ? product.price * qty : 0);
                }, 0);
            };

            // =============================================
            // 訂單處理函式
            // =============================================
            const generateOrderId = () => {
                const date = new Date();
                const dateStr = date.toISOString().slice(0,10).replace(/-/g, '');
                const random = Math.floor(Math.random() * 9000 + 1000);
                return `${ORDER_ID_PREFIX}-${dateStr}-${random}`;
            };

            const sendToGoogleSheets = async (finalOrder) => {
                if (!GOOGLE_SCRIPT_URL) throw new Error('請先設定 GOOGLE_SCRIPT_URL');

                const itemsSummary = Object.entries(finalOrder.items).map(([id, qty]) => {
                    const product = initialProducts.find(p => p.id === parseInt(id));
                    return `${product.name} x${qty}`;
                }).join(", ");

                const payload = {
                    // 【安全性】sheetId 已移至後端腳本屬性
                    orderId: finalOrder.id,
                    isUpdate: finalOrder.isUpdate || false,  // 標記是否為更新
                    timestamp: finalOrder.date,
                    consultantName: finalOrder.consultant.name,
                    consultantId: finalOrder.consultant.id,
                    consultantLocation: finalOrder.consultant.location,
                    customerName: finalOrder.customer.name,
                    customerPhone: finalOrder.customer.phone,
                    customerEmail: finalOrder.customer.email,
                    customerBirthday: finalOrder.customer.birthday,
                    customerAddress: finalOrder.customer.address,
                    customerCompany: finalOrder.customer.company,
                    customerTaxId: finalOrder.customer.taxId,
                    customerSource: finalOrder.customer.source,
                    customerNotes: finalOrder.customer.notes,
                    customerAppointmentDate: finalOrder.customer.appointmentDate,
                    customerAppointmentPeriod: finalOrder.customer.appointmentPeriod,
                    customerAppointmentTime: finalOrder.customer.appointmentTime,
                    itemsSummary,
                    items: finalOrder.items,
                    total: finalOrder.total,
                    signature: finalOrder.signature
                };

                console.log('Sending to Google Sheets:', payload);

                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });

                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text || '{}');
                } catch (err) {
                    throw new Error('Google Apps Script 回傳格式錯誤');
                }

                if (!response.ok || data.status !== 'ok') {
                    throw new Error(data.message || '寫入 Google Sheet 失敗');
                }

                return data;
            };

            const getInputClass = (isError) => {
                const baseClass = "w-full p-3 rounded-xl border outline-none transition-all placeholder:text-gray-400";
                if (isError) {
                    return `${baseClass} border-red-500 ring-2 ring-red-500/20 bg-red-50 text-red-900`;
                }
                return `${baseClass} border-gray-200 focus:border-purple-500 bg-white`;
            };

            // =============================================
            // 表單提交處理
            // =============================================
            const handleSubmit = async (e) => {
                e.preventDefault();

                // 驗證必填欄位
                const newErrors = {};
                if (!consultantInfo.name) newErrors.consultant_name = true;
                if (!consultantInfo.id) newErrors.consultant_id = true;
                if (!consultantInfo.location) newErrors.consultant_location = true;
                if (!customerInfo.name) newErrors.customer_name = true;
                if (!customerInfo.phone) newErrors.customer_phone = true;
                if (!customerInfo.email) newErrors.customer_email = true;
                if (!customerInfo.source) newErrors.customer_source = true;
                if (!customerInfo.appointmentDate) newErrors.customer_appointmentDate = true;
                if (!customerInfo.appointmentPeriod) newErrors.customer_appointmentPeriod = true;
                if (!customerInfo.appointmentTime) newErrors.customer_appointmentTime = true;

                if (customerInfo.birthday && customerInfo.birthday.length !== 8) {
                    newErrors.customer_birthday = true;
                    alert("生日格式錯誤！請輸入完整的 8 位數西元生日 (例如 19900101)");
                }

                if (Object.keys(newErrors).length > 0) {
                    setErrors(newErrors);
                    const firstErrorId = Object.keys(newErrors)[0];
                    const element = document.getElementById(firstErrorId);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        element.focus();
                    }
                    return;
                }

                if (calculateTotal() === 0) { alert("請至少選擇一項服務！"); return; }
                if (!signatureData) { alert("請完成客戶簽名！"); return; }

                setIsSubmitting(true);

                // 如果是編輯模式則使用原訂單編號，否則產生新編號
                const isUpdate = !!editingOrderId;
                const orderId = editingOrderId || generateOrderId();
                const deadline = Date.now() + PAYMENT.DEADLINE_MS;
                const finalOrder = {
                    id: orderId,
                    isUpdate: isUpdate,  // 標記是否為更新
                    consultant: consultantInfo,
                    customer: customerInfo,
                    items: cart,
                    total: calculateTotal(),
                    date: new Date().toLocaleString('zh-TW'),
                    signature: signatureData,
                    deadline: deadline
                };

                try {
                    await sendToGoogleSheets(finalOrder);
                } catch (err) {
                    console.error(err);
                    alert(err.message || '無法寫入 Google Sheet，請稍後再試。');
                    setIsSubmitting(false);
                    return;
                }

                // 儲存訂單並清除草稿
                localStorage.setItem(STORAGE_KEY, JSON.stringify(finalOrder));
                localStorage.removeItem(DRAFT_KEY);

                // 跳轉到成功頁面
                window.location.href = 'order-success.html';
            };

            // =============================================
            // 渲染
            // =============================================
            return (
                <div className="min-h-screen bg-[#f5f5f7] font-sans pb-28 sm:pb-32">
                    {/* Top Bar */}
                    <div className={`fixed top-0 left-0 right-0 z-50 transition-all duration-300 safe-area-top ${scrolled ? 'bg-white/80 backdrop-blur-md border-b border-gray-200/50' : ''}`}>
                        <div className="max-w-3xl lg:max-w-4xl mx-auto px-4 sm:px-6 py-3 sm:py-4 flex items-center justify-between">
                            <div className="flex items-center gap-1.5 sm:gap-2 font-semibold text-sm sm:text-base text-[#1d1d1f]">
                                <span className="w-7 h-7 sm:w-8 sm:h-8 bg-gradient-to-tr from-purple-600 to-indigo-600 rounded-lg text-white flex items-center justify-center shadow-lg shadow-purple-500/20"><Sparkles className="w-3.5 h-3.5 sm:w-4 sm:h-4" /></span>
                                吾飛藝術銀行
                            </div>
                            <div className="text-[8px] sm:text-[10px] text-gray-400 flex items-center gap-1">
                                <Save className="w-2.5 h-2.5 sm:w-3 sm:h-3" /> 草稿已自動暫存
                            </div>
                        </div>
                    </div>

                    <div className="pt-20 sm:pt-24 md:pt-28 pb-6 sm:pb-8 md:pb-10 px-4 sm:px-6 text-center max-w-xl lg:max-w-2xl mx-auto">
                        <h1 className="text-2xl sm:text-3xl md:text-4xl font-bold text-[#1d1d1f] mb-1 sm:mb-2">會員服務訂購單</h1>
                        <p className="text-gray-500 text-xs sm:text-sm">盤點過去，啟動未來無限潛能。</p>
                    </div>

                    <div className="max-w-xl lg:max-w-2xl mx-auto px-4 sm:px-6 space-y-6 sm:space-y-8">
                        {/* 顧問資料區塊 */}
                        <section className="space-y-3 sm:space-y-4">
                            <h3 className="text-base sm:text-lg font-bold border-b border-gray-200 pb-2 text-[#1d1d1f]">服務顧問</h3>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3">
                                <div className="space-y-1">
                                    <label className="text-[10px] sm:text-xs text-gray-400">顧問姓名 <span className="text-red-500">*</span></label>
                                    <input id="consultant_name" type="text" name="name" value={consultantInfo.name} onChange={handleConsultantChange} className={getInputClass(errors.consultant_name)} placeholder="請輸入 *" />
                                </div>
                                <div className="space-y-1">
                                    <label className="text-[10px] sm:text-xs text-gray-400">顧問編號 <span className="text-red-500">*</span></label>
                                    <input id="consultant_id" type="text" name="id" value={consultantInfo.id} onChange={handleConsultantChange} className={getInputClass(errors.consultant_id)} placeholder="C001 *" />
                                </div>
                                <div className="sm:col-span-2 space-y-1">
                                    <label className="text-[10px] sm:text-xs text-gray-400">服務據點 <span className="text-red-500">*</span></label>
                                    <div className="relative">
                                        <select id="consultant_location" name="location" value={consultantInfo.location} onChange={handleConsultantChange} className={`${getInputClass(errors.consultant_location)} appearance-none text-sm sm:text-base`}>
                                            {LOCATIONS.map(loc => (<option key={loc.value} value={loc.value}>{loc.label}</option>))}
                                        </select>
                                        <ChevronDown className="absolute right-3 top-3.5 sm:top-4 w-4 h-4 text-gray-400 pointer-events-none" />
                                    </div>
                                </div>
                            </div>
                        </section>

                        {/* 客戶資料區塊 */}
                        <section className="space-y-3 sm:space-y-4">
                            <h3 className="text-base sm:text-lg font-bold border-b border-gray-200 pb-2 text-[#1d1d1f]">客戶資料</h3>
                            <div className="space-y-2 sm:space-y-3">
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3">
                                    <input id="customer_name" type="text" name="name" value={customerInfo.name} onChange={handleInputChange} placeholder="客戶姓名 *" className={getInputClass(errors.customer_name)} />
                                    <input id="customer_phone" type="tel" name="phone" value={customerInfo.phone} onChange={handleInputChange} placeholder="聯絡電話 *" className={getInputClass(errors.customer_phone)} />
                                </div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3">
                                    <input id="customer_birthday" type="tel" name="birthday" value={customerInfo.birthday} onChange={handleInputChange} maxLength={8} placeholder="生日 (YYYYMMDD) *" className={getInputClass(errors.customer_birthday)} />
                                    <input id="customer_email" type="email" name="email" value={customerInfo.email} onChange={handleInputChange} placeholder="信箱 *" className={getInputClass(errors.customer_email)} />
                                </div>
                                <div>
                                    <input type="text" name="address" value={customerInfo.address} onChange={handleInputChange} placeholder="地址" className="w-full p-3 sm:p-4 rounded-xl border border-gray-200 outline-none focus:border-purple-500 bg-white placeholder-gray-400 text-sm sm:text-base" />
                                </div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3">
                                    <input type="text" name="company" value={customerInfo.company} onChange={handleInputChange} placeholder="公司名稱" className="w-full p-3 sm:p-4 rounded-xl border border-gray-200 outline-none focus:border-purple-500 bg-white placeholder-gray-400 text-sm sm:text-base" />
                                    <input type="text" name="taxId" value={customerInfo.taxId} onChange={handleInputChange} placeholder="統一編號" className="w-full p-3 sm:p-4 rounded-xl border border-gray-200 outline-none focus:border-purple-500 bg-white placeholder-gray-400 text-sm sm:text-base" />
                                </div>
                                <div className="relative">
                                    <Info className="absolute left-3 sm:left-4 top-3 sm:top-4 w-4 h-4 sm:w-5 sm:h-5 text-purple-600" />
                                    <input id="customer_source" type="text" name="source" value={customerInfo.source} onChange={handleInputChange} placeholder="資訊來源 (例: 網路搜尋) *" className={`${getInputClass(errors.customer_source)} pl-10 sm:pl-12 text-sm sm:text-base`} />
                                </div>
                            </div>
                        </section>

                        {/* 產品選擇區塊 */}
                        <section className="space-y-3 sm:space-y-4">
                            <h3 className="text-base sm:text-lg font-bold border-b border-gray-200 pb-2 text-[#1d1d1f]">選擇服務方案</h3>
                            <div className="space-y-3 sm:space-y-4">
                                {initialProducts.map((product) => {
                                    const qty = cart[product.id] || 0;
                                    const isSelected = qty > 0;
                                    const isExpanded = expandedCards[product.id];
                                    return (
                                        <div key={product.id} onClick={() => toggleExpand(product.id)} className={`bg-white rounded-2xl sm:rounded-3xl transition-all duration-300 cursor-pointer overflow-hidden relative desktop-hover-scale ${isSelected ? 'ring-2 ring-purple-600 shadow-lg' : 'border border-gray-100 shadow-sm'}`}>
                                            {product.popular && <div className="absolute top-0 right-0 bg-purple-600 text-white text-[8px] sm:text-[10px] font-bold px-2 sm:px-3 py-0.5 sm:py-1 rounded-bl-xl z-10">POPULAR</div>}
                                            <div className="p-4 sm:p-6 flex items-center justify-between">
                                                <div className="flex items-center gap-3 sm:gap-4">
                                                    <div className={`w-11 h-11 sm:w-14 sm:h-14 rounded-xl sm:rounded-2xl flex items-center justify-center text-white bg-gradient-to-br ${product.color}`}>
                                                        {React.cloneElement(product.icon, { className: 'w-6 h-6 sm:w-8 sm:h-8' })}
                                                    </div>
                                                    <div>
                                                        <div className="text-[8px] sm:text-[10px] text-gray-400 font-bold uppercase tracking-wider">{product.subName}</div>
                                                        <div className="text-base sm:text-lg font-bold text-[#1d1d1f]">{product.name}</div>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-2 sm:gap-3">
                                                    {!isSelected && <div className="text-right hidden md:block"><div className="font-bold text-sm sm:text-base">NT$ {product.price.toLocaleString()}</div></div>}
                                                    <ChevronDown className={`w-4 h-4 sm:w-5 sm:h-5 text-gray-400 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
                                                </div>
                                            </div>
                                            <div className={`bg-gray-50 overflow-hidden transition-all duration-300 ${isExpanded ? 'max-h-[500px] opacity-100' : 'max-h-0 opacity-0'}`}>
                                                <div className="p-4 sm:p-6 pt-2">
                                                    <p className="text-xs sm:text-sm text-gray-600 mb-3 sm:mb-4">{product.description}</p>
                                                    <div className="space-y-1.5 sm:space-y-2 mb-3 sm:mb-4">{product.features.map((f, i) => <div key={i} className="flex items-center gap-1.5 sm:gap-2 text-[10px] sm:text-xs text-gray-500"><Check className="w-2.5 h-2.5 sm:w-3 sm:h-3 text-purple-600 flex-shrink-0" /> {f}</div>)}</div>
                                                    <div className="flex flex-col sm:flex-row justify-between items-stretch sm:items-center gap-3 sm:gap-0 bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                                                        <div><div className="text-[10px] sm:text-xs text-gray-400">費用</div><div className="font-bold text-base sm:text-lg">NT$ {product.price.toLocaleString()}</div></div>
                                                        {qty === 0 ? (
                                                            <button onClick={(e) => { e.stopPropagation(); updateQuantity(product.id, 1); }} className="bg-[#1d1d1f] text-white px-5 sm:px-6 py-2 sm:py-2.5 rounded-full text-xs sm:text-sm font-bold shadow-lg active:scale-95 transition-transform w-full sm:w-auto">購買</button>
                                                        ) : (
                                                            <div className="flex items-center justify-center gap-3 bg-[#f5f5f7] rounded-full p-1"><button onClick={(e) => { e.stopPropagation(); updateQuantity(product.id, -1); }} className="w-8 h-8 sm:w-9 sm:h-9 bg-white rounded-full flex items-center justify-center shadow-sm active:scale-95 transition-transform"><Minus className="w-3 h-3" /></button><span className="font-bold w-4 text-center">{qty}</span><button onClick={(e) => { e.stopPropagation(); updateQuantity(product.id, 1); }} className="w-8 h-8 sm:w-9 sm:h-9 bg-[#1d1d1f] text-white rounded-full flex items-center justify-center shadow-sm active:scale-95 transition-transform"><Plus className="w-3 h-3" /></button></div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </section>

                        {/* 預約行事曆區塊 - LGI 簡約風格 */}
                        <section className="space-y-3 sm:space-y-4">
                            <h3 className="text-base sm:text-lg font-bold border-b border-gray-200 pb-2 text-[#1d1d1f]">預約行事曆</h3>
                            <div className="bg-white rounded-xl sm:rounded-2xl overflow-hidden shadow-sm border border-gray-100 relative" style={{ fontFamily: "'DM Sans', sans-serif" }}>
                                {/* 行事曆頂部：月份與導航 */}
                                <div className="px-3 sm:px-5 pt-4 sm:pt-5 pb-3 flex items-center justify-between">
                                    <h4 className="text-base sm:text-lg font-semibold text-[#1d1d1f] tracking-tight">
                                        {calendarMonth.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' })}
                                    </h4>
                                    <div className="flex items-center gap-1">
                                        <button
                                            onClick={() => setCalendarMonth(new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() - 1))}
                                            className="w-6 h-6 sm:w-7 sm:h-7 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors text-gray-500 text-sm"
                                        >
                                            ←
                                        </button>
                                        <button
                                            onClick={() => setCalendarMonth(new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() + 1))}
                                            className="w-6 h-6 sm:w-7 sm:h-7 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors text-gray-500 text-sm"
                                        >
                                            →
                                        </button>
                                    </div>
                                </div>

                                {/* 星期標題列 */}
                                <div className="grid grid-cols-7 border-t border-gray-100">
                                    {['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map((day, i) => (
                                        <div key={i} className="py-1.5 sm:py-2 text-center text-[9px] sm:text-[10px] font-medium text-gray-400 uppercase tracking-wider">
                                            {day}
                                        </div>
                                    ))}
                                </div>

                                {/* 日期格線 */}
                                <div className="grid grid-cols-7 border-t border-gray-100">
                                    {getCalendarDays(calendarMonth).map((dayObj, idx) => {
                                        const { date, isCurrentMonth } = dayObj;
                                        const dayEvents = getEventsForDay(date);
                                        const isToday = date.toDateString() === new Date().toDateString();
                                        const isSelected = customerInfo.appointmentDate && date.toDateString() === new Date(customerInfo.appointmentDate).toDateString();

                                        return (
                                            <div
                                                key={idx}
                                                onClick={() => {
                                                    if (isCurrentMonth && !isPastDate(date)) {
                                                        setCustomerInfo(prev => ({ ...prev, appointmentDate: formatDateString(date) }));
                                                        if (errors.customer_appointmentDate) {
                                                            setErrors(prev => ({ ...prev, customer_appointmentDate: false }));
                                                        }
                                                    }
                                                }}
                                                className={`min-h-[60px] sm:min-h-[72px] md:min-h-[85px] p-1 sm:p-1.5 border-b border-r border-gray-100 cursor-pointer transition-colors ${
                                                    !isCurrentMonth ? 'bg-gray-50/50' : 'hover:bg-gray-50'
                                                } ${
                                                    isSelected ? 'bg-purple-50 ring-1 ring-purple-400 ring-inset' : ''
                                                } ${
                                                    idx % 7 === 6 ? 'border-r-0' : ''
                                                }`}
                                            >
                                                {/* 日期數字 */}
                                                <div className={`text-lg sm:text-xl md:text-2xl font-light leading-none mb-0.5 sm:mb-1 ${
                                                    !isCurrentMonth ? 'text-gray-300' : isToday ? 'text-red-500 font-normal' : 'text-[#1d1d1f]'
                                                }`}>
                                                    {date.getDate()}
                                                </div>

                                                {/* 事件列表 */}
                                                <div className="space-y-0.5">
                                                    {dayEvents.slice(0, 2).map((ev, i) => (
                                                        <div
                                                            key={ev.id || i}
                                                            className="text-[8px] sm:text-[10px] leading-tight truncate text-gray-600"
                                                            title={ev.title}
                                                        >
                                                            {ev.title}
                                                        </div>
                                                    ))}
                                                    {dayEvents.length > 2 && (
                                                        <div className="text-[8px] sm:text-[9px] text-gray-400">
                                                            +{dayEvents.length - 2}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>

                                {/* 載入中提示 */}
                                {calendarLoading && (
                                    <div className="absolute inset-0 bg-white/80 flex items-center justify-center">
                                        <Loader2 className="w-5 h-5 animate-spin text-purple-600" />
                                    </div>
                                )}

                                {/* 預約區域 */}
                                <div className="p-3 sm:p-4 bg-gray-50 border-t border-gray-100 space-y-3">
                                    {calendarError && (
                                        <div className="text-xs sm:text-sm text-red-500 flex items-center gap-2">
                                            <Info className="w-4 h-4 flex-shrink-0" />
                                            {calendarError}
                                        </div>
                                    )}

                                    {/* 已選擇日期顯示 */}
                                    <div className="space-y-1">
                                        <label className="text-[10px] sm:text-xs text-gray-400 font-medium">預約日期 <span className="text-red-500">*</span></label>
                                        <div className={`p-3 rounded-xl border ${errors.customer_appointmentDate ? 'border-red-500 bg-red-50' : 'border-gray-200 bg-white'} flex items-center justify-between`}>
                                            <span className={customerInfo.appointmentDate ? 'text-[#1d1d1f] font-medium' : 'text-gray-400'}>
                                                {customerInfo.appointmentDate ? new Date(customerInfo.appointmentDate).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }) : '請從上方行事曆點選日期'}
                                            </span>
                                            {customerInfo.appointmentDate && (
                                                <button
                                                    type="button"
                                                    onClick={() => setCustomerInfo(prev => ({ ...prev, appointmentDate: '' }))}
                                                    className="text-xs text-gray-400 hover:text-red-500 transition-colors"
                                                >
                                                    清除
                                                </button>
                                            )}
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-2 sm:gap-3">
                                        {/* 時段選擇 - 自定義下拉選單 */}
                                        <div className="space-y-1" ref={periodRef}>
                                            <label className="text-[10px] sm:text-xs text-gray-400 font-medium">時段 <span className="text-red-500">*</span></label>
                                            <div className="relative">
                                                <button
                                                    type="button"
                                                    onClick={() => {
                                                        setShowPeriodDropdown(!showPeriodDropdown);
                                                        setShowTimeDropdown(false);
                                                    }}
                                                    className={`${getInputClass(errors.customer_appointmentPeriod)} text-sm sm:text-base text-left flex items-center justify-between w-full`}
                                                >
                                                    <span>
                                                        {customerInfo.appointmentPeriod === 'morning' && '上午'}
                                                        {customerInfo.appointmentPeriod === 'afternoon' && '下午'}
                                                        {customerInfo.appointmentPeriod === 'evening' && '晚上'}
                                                    </span>
                                                    <ChevronDown className={`w-4 h-4 text-gray-400 transition-transform duration-200 ${showPeriodDropdown ? 'rotate-180' : ''}`} />
                                                </button>

                                                {showPeriodDropdown && (
                                                    <div data-dropdown="period" className="fixed z-[90] bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden animate-slide-down" style={{
                                                        top: periodRef.current ? periodRef.current.getBoundingClientRect().bottom + 4 : 'auto',
                                                        left: periodRef.current ? periodRef.current.getBoundingClientRect().left : '16px',
                                                        width: periodRef.current ? periodRef.current.getBoundingClientRect().width : 'auto'
                                                    }}>
                                                        {[
                                                            { value: 'morning', label: '上午', time: '09:00 - 12:00' },
                                                            { value: 'afternoon', label: '下午', time: '13:00 - 17:00' },
                                                            { value: 'evening', label: '晚上', time: '18:00 - 21:00' }
                                                        ].map((period) => (
                                                            <button
                                                                key={period.value}
                                                                type="button"
                                                                onClick={() => {
                                                                    setCustomerInfo(prev => ({ ...prev, appointmentPeriod: period.value, appointmentTime: '' }));
                                                                    setShowPeriodDropdown(false);
                                                                    if (errors.customer_appointmentPeriod) {
                                                                        setErrors(prev => ({ ...prev, customer_appointmentPeriod: false }));
                                                                    }
                                                                }}
                                                                className={`w-full px-3 py-2.5 sm:px-4 sm:py-3 text-left hover:bg-purple-50 transition-colors flex items-center justify-between group ${
                                                                    customerInfo.appointmentPeriod === period.value ? 'bg-purple-50' : ''
                                                                }`}
                                                            >
                                                                <div>
                                                                    <div className="text-sm sm:text-base font-medium text-[#1d1d1f]">{period.label}</div>
                                                                    <div className="text-[10px] sm:text-xs text-gray-400">{period.time}</div>
                                                                </div>
                                                                {customerInfo.appointmentPeriod === period.value && (
                                                                    <Check className="w-4 h-4 text-purple-600" />
                                                                )}
                                                            </button>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* 時間選擇 - 自定義下拉選單 */}
                                        <div className="space-y-1" ref={timeRef}>
                                            <label className="text-[10px] sm:text-xs text-gray-400 font-medium">時間 <span className="text-red-500">*</span></label>
                                            <div className="relative">
                                                <button
                                                    type="button"
                                                    onClick={() => {
                                                        setShowTimeDropdown(!showTimeDropdown);
                                                        setShowPeriodDropdown(false);
                                                    }}
                                                    className={`${getInputClass(errors.customer_appointmentTime)} text-sm sm:text-base text-left flex items-center justify-between w-full`}
                                                >
                                                    <span className={customerInfo.appointmentTime ? 'text-[#1d1d1f]' : 'text-gray-400'}>
                                                        {customerInfo.appointmentTime || '選擇時間'}
                                                    </span>
                                                    <ChevronDown className={`w-4 h-4 text-gray-400 transition-transform duration-200 ${showTimeDropdown ? 'rotate-180' : ''}`} />
                                                </button>

                                                {showTimeDropdown && (
                                                    <div data-dropdown="time" className="fixed z-[90] bg-white rounded-xl border border-gray-200 shadow-xl max-h-[240px] overflow-y-auto animate-slide-down custom-scrollbar" style={{
                                                        top: timeRef.current ? timeRef.current.getBoundingClientRect().bottom + 4 : 'auto',
                                                        left: timeRef.current ? timeRef.current.getBoundingClientRect().left : '16px',
                                                        width: timeRef.current ? timeRef.current.getBoundingClientRect().width : 'auto'
                                                    }}>
                                                        {(() => {
                                                            const times = [];
                                                            if (customerInfo.appointmentPeriod === 'morning') {
                                                                times.push('09:00', '09:30', '10:00', '10:30', '11:00', '11:30');
                                                            } else if (customerInfo.appointmentPeriod === 'afternoon') {
                                                                times.push('13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30');
                                                            } else if (customerInfo.appointmentPeriod === 'evening') {
                                                                times.push('18:00', '18:30', '19:00', '19:30', '20:00', '20:30', '21:00');
                                                            }

                                                            return times.map((time) => (
                                                                <button
                                                                    key={time}
                                                                    type="button"
                                                                    onClick={() => {
                                                                        setCustomerInfo(prev => ({ ...prev, appointmentTime: time }));
                                                                        setShowTimeDropdown(false);
                                                                        if (errors.customer_appointmentTime) {
                                                                            setErrors(prev => ({ ...prev, customer_appointmentTime: false }));
                                                                        }
                                                                    }}
                                                                    className={`w-full px-3 py-2.5 sm:px-4 sm:py-3 text-left hover:bg-purple-50 transition-colors flex items-center justify-between ${
                                                                        customerInfo.appointmentTime === time ? 'bg-purple-50' : ''
                                                                    }`}
                                                                >
                                                                    <span className="text-sm sm:text-base font-medium text-[#1d1d1f]">{time}</span>
                                                                    {customerInfo.appointmentTime === time && (
                                                                        <Check className="w-4 h-4 text-purple-600" />
                                                                    )}
                                                                </button>
                                                            ));
                                                        })()}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>

                        {/* 簽名板區塊 */}
                        <section>
                            <h3 className="text-base sm:text-lg font-bold border-b border-gray-200 pb-2 text-[#1d1d1f] mb-3 sm:mb-4">客戶簽名</h3>
                            <div className="bg-white rounded-xl sm:rounded-2xl border-2 border-dashed border-gray-300 p-4 sm:p-6 flex flex-col items-center justify-center min-h-[120px] sm:min-h-[140px] relative overflow-hidden">
                                {signatureData ? (
                                    <div className="flex flex-col items-center w-full">
                                        <img src={signatureData} alt="Sign" className="h-16 sm:h-20 mb-2 sm:mb-3 object-contain" />
                                        <div className="flex gap-2 sm:gap-3">
                                            <button onClick={() => setShowSignatureModal(true)} className="text-[10px] sm:text-xs text-purple-600 font-bold bg-purple-50 px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg flex items-center gap-1 hover:bg-purple-100 active:scale-95 transition-all"><Edit3 className="w-2.5 h-2.5 sm:w-3 sm:h-3" /> 重簽</button>
                                            <button onClick={() => setSignatureData(null)} className="text-[10px] sm:text-xs text-red-500 font-bold bg-red-50 px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg flex items-center gap-1 hover:bg-red-100 active:scale-95 transition-all"><Trash2 className="w-2.5 h-2.5 sm:w-3 sm:h-3" /> 刪除</button>
                                        </div>
                                    </div>
                                ) : (
                                    <button onClick={() => setShowSignatureModal(true)} className="w-full h-full absolute inset-0 flex flex-col items-center justify-center text-gray-400 hover:bg-gray-50 active:bg-gray-100 transition-colors">
                                        <PenTool className="w-5 h-5 sm:w-6 sm:h-6 mb-1.5 sm:mb-2" />
                                        <span className="text-xs sm:text-sm font-medium">點此開啟簽名板</span>
                                    </button>
                                )}
                            </div>
                            <div className="mt-3 sm:mt-4 flex gap-2 sm:gap-3 p-2.5 sm:p-3 bg-gray-50 rounded-lg sm:rounded-xl text-[10px] sm:text-xs text-gray-500 leading-relaxed border border-gray-100">
                                <ShieldCheck className="w-3.5 h-3.5 sm:w-4 sm:h-4 flex-shrink-0 text-gray-400 mt-0.5" />
                                <div>
                                    <p>1. 以上資料皆用於公司內部建檔及紀錄。</p>
                                    <p className="mt-0.5 sm:mt-1">2. 公司嚴格遵守隱私權、個資保護。</p>
                                    <p className="mt-0.5 sm:mt-1">3. 本公司絕不向第三方揭露您的任何資訊，並確認以上填寫資料無誤。</p>
                                </div>
                            </div>
                        </section>
                    </div>

                    {/* Footer CTA */}
                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-3 sm:p-4 md:p-5 z-40 safe-area-bottom">
                        <div className="max-w-3xl lg:max-w-4xl mx-auto flex items-center justify-between gap-3">
                            <div className="flex-shrink-0">
                                <div className="text-[8px] sm:text-[10px] text-gray-400 uppercase tracking-wider">Total</div>
                                <div className="text-xl sm:text-2xl md:text-3xl font-bold text-[#1d1d1f]">NT$ {calculateTotal().toLocaleString()}</div>
                            </div>
                            <button onClick={handleSubmit} disabled={isSubmitting} className={`px-5 sm:px-6 md:px-8 py-2.5 sm:py-3 rounded-full font-bold text-sm sm:text-base flex items-center gap-1.5 sm:gap-2 shadow-xl active:scale-95 transition-transform ${isSubmitting ? 'bg-gray-200 text-gray-400' : 'bg-[#1d1d1f] text-white hover:bg-black'}`}>
                                {isSubmitting ? <Loader2 className="w-3.5 h-3.5 sm:w-4 sm:h-4 animate-spin" /> : <><Send className="w-3.5 h-3.5 sm:w-4 sm:h-4" /> 送出訂購單</>}
                            </button>
                        </div>
                    </div>

                    {/* Signature Modal */}
                    {showSignatureModal && (
                        <div className="fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm flex items-end sm:items-center justify-center">
                            <div className="bg-white w-full sm:max-w-lg md:max-w-xl lg:max-w-2xl sm:rounded-2xl rounded-t-2xl flex flex-col h-[80vh] sm:h-[550px] md:h-[600px] ipad-landscape-fix animate-slide-up">
                                <div className="p-3 sm:p-4 border-b flex justify-between items-center">
                                    <h3 className="font-bold text-sm sm:text-base">請簽名</h3>
                                    <button onClick={() => setShowSignatureModal(false)} className="p-1 hover:bg-gray-100 rounded-full transition-colors"><X className="w-5 h-5 sm:w-6 sm:h-6 text-gray-400" /></button>
                                </div>
                                <div className="flex-1 bg-[#f5f5f7] relative m-3 sm:m-4 rounded-xl border-2 border-dashed border-gray-300 touch-none overflow-hidden">
                                    <canvas ref={canvasRef} onMouseDown={startDrawing} onMouseMove={draw} onMouseUp={stopDrawing} onMouseLeave={stopDrawing} onTouchStart={startDrawing} onTouchMove={draw} onTouchEnd={stopDrawing} className="block w-full h-full cursor-crosshair" />
                                    {!modalHasSignature && !isDrawing && (<div className="absolute inset-0 flex items-center justify-center pointer-events-none text-gray-400 gap-2 text-sm sm:text-base"><PenTool className="w-4 h-4 sm:w-5 sm:h-5" /> 請在此區域簽名</div>)}
                                </div>
                                <div className="p-3 sm:p-4 border-t flex gap-2 sm:gap-3 safe-area-bottom">
                                    <button onClick={clearCanvas} className="flex-1 py-2.5 sm:py-3 bg-gray-100 rounded-xl font-bold text-sm sm:text-base text-gray-600 flex justify-center items-center gap-1.5 sm:gap-2 active:scale-95 transition-transform"><Eraser className="w-3.5 h-3.5 sm:w-4 sm:h-4" /> 清除</button>
                                    <button onClick={confirmSignature} className="flex-[2] py-2.5 sm:py-3 bg-[#1d1d1f] text-white rounded-xl font-bold text-sm sm:text-base flex justify-center items-center gap-1.5 sm:gap-2 shadow-lg active:scale-95 transition-transform"><Check className="w-3.5 h-3.5 sm:w-4 sm:h-4" /> 確認</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // =============================================
        // 掛載 React 應用
        // =============================================
        const root = createRoot(document.getElementById('root'));
        root.render(<OrderFormPage />);
    </script>
</body>
</html>
