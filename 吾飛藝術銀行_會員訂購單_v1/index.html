<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>吾飛藝術銀行 - 會員服務訂購單</title>
    
    <!-- 1. 引入 Tailwind CSS (樣式框架) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 引入 Babel (用於瀏覽器端編譯 React JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. 引入 html2canvas (用於截圖功能) -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* 優化移動端體驗：防止 iOS 橡皮筋捲動，優化簽名板操作 */
        html, body {
            overscroll-behavior: none;
            touch-action: pan-x pan-y;
        }
        /* 美化捲軸 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        /* 簽名時鎖定觸控 */
        .touch-none { touch-action: none !important; }
        
        /* 修正 iOS Date Input 樣式問題 */
        input[type="date"] {
            -webkit-appearance: none;
            appearance: none;
            min-height: 56px; /* 確保高度 */
        }
    </style>
</head>
<body class="bg-[#f5f5f7]">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // 引入 React 與 Lucide 圖標庫 (新增 Trash2 圖標)
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            ChevronDown, Check, Send, User, Building, 
            Mail, Phone, Info, Plus, Minus, Sparkles, Heart, 
            Briefcase, Network, Calendar, MapPin, FileText, Tag, Store, 
            PenTool, Eraser, X, Edit3, Copy, CreditCard, MessageCircle, Clock, ArrowLeft, RefreshCw, AlertCircle, Image as ImageIcon, Share2, Loader2, QrCode, ShieldCheck, Save, Trash2
        } from 'https://esm.sh/lucide-react@0.263.1';

        // =================================================================
        // 【工程師設定區】請填入部署好的 Google Apps Script URL
        // 格式範例: "https://script.google.com/macros/s/xxxxxxxxx/exec"
        const GOOGLE_SCRIPT_URL = "［https://script.google.com/macros/s/AKfycbzss8ss-yztmNfDKGIUP3X8iEIwQ0j2sAgrRygxiwNgZ02Vdz4gY69JKljQXIiYjY8a/exec)"; 
        // =================================================================

        // 倒數計時器元件
        const CountdownTimer = ({ deadline }) => {
            const [timeLeft, setTimeLeft] = useState(Math.max(0, deadline - Date.now()));

            useEffect(() => {
                const timer = setInterval(() => {
                    const newTimeLeft = deadline - Date.now();
                    if (newTimeLeft <= 0) {
                        clearInterval(timer);
                        setTimeLeft(0);
                    } else {
                        setTimeLeft(newTimeLeft);
                    }
                }, 1000);
                return () => clearInterval(timer);
            }, [deadline]);

            const formatTime = (ms) => {
                if (ms <= 0) return "已截止";
                const totalSeconds = Math.floor(ms / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            };

            return (
                <span className={`font-mono font-bold text-lg ${timeLeft <= 0 ? 'text-gray-500' : 'text-red-600'}`}>
                    {formatTime(timeLeft)}
                </span>
            );
        };

        const OrderForm = () => {
            // 產品資料定義
            const initialProducts = [
                {
                    id: 1,
                    name: '個人光譜檢測',
                    subName: 'Spectrum',
                    price: 3888,
                    period: '/30min',
                    description: '透過獨家光譜技術，快速掃描個人當下的能量狀態與色彩頻率。',
                    features: ['個人能量場分析', '專屬色彩頻率解碼', '提供平衡建議方案'],
                    icon: <Sparkles className="w-8 h-8" />,
                    color: 'from-pink-400 to-rose-500'
                },
                {
                    id: 2,
                    name: '個人軌跡盤點',
                    subName: 'Individual',
                    price: 7888,
                    period: '/1H',
                    description: '深入探索個人生命歷程，釐清核心價值與潛意識動力。',
                    features: ['生命歷程回顧', '潛能天賦挖掘', '核心價值觀釐清', '未來路徑規劃'],
                    icon: <User className="w-8 h-8" />,
                    popular: true,
                    color: 'from-violet-500 to-purple-600'
                },
                {
                    id: 3,
                    name: '家庭軌跡盤點',
                    subName: 'Family',
                    price: 22800,
                    period: '/2H',
                    description: '解析家庭成員間的能量互動與關係動力，修復連結並建立和諧氛圍。',
                    features: ['親子/伴侶關係解碼', '家庭動力系統排列', '居家能量場調整'],
                    icon: <Heart className="w-8 h-8" />,
                    color: 'from-orange-400 to-amber-500'
                },
                {
                    id: 4,
                    name: '企業軌跡盤點',
                    subName: 'Corporate',
                    price: 68000,
                    period: '/3H',
                    description: '為企業組織進行全面性的能量診斷，優化團隊動能。',
                    features: ['組織動能分析', '領導力與決策優化', '團隊共識凝聚'],
                    icon: <Briefcase className="w-8 h-8" />,
                    color: 'from-slate-600 to-slate-800'
                },
                {
                    id: 5,
                    name: '家族軌跡盤點',
                    subName: 'Genealogy',
                    price: 98000,
                    period: '/4H',
                    description: '跨越世代的家族系統深度盤點，轉化家族傳承的印記。',
                    features: ['家族系統排列深度諮詢', '跨世代連結修復', '根源力量整合'],
                    icon: <Network className="w-8 h-8" />,
                    color: 'from-emerald-500 to-teal-700'
                }
            ];

            // 狀態管理 - 確保初始值為空 (Production Ready)
            const [consultantInfo, setConsultantInfo] = useState({ name: '', id: '', location: '桃園館' });
            
            // 客戶資料欄位依照新需求設定
            const [customerInfo, setCustomerInfo] = useState({ 
                name: '', phone: '', birthday: '', email: '', 
                address: '', company: '', taxId: '', source: '', notes: '' 
            });
            
            // 錯誤狀態管理
            const [errors, setErrors] = useState({});

            const [expandedCards, setExpandedCards] = useState({});
            const [cart, setCart] = useState({});
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [submitStatus, setSubmitStatus] = useState(null);
            const [scrolled, setScrolled] = useState(false);
            const [restored, setRestored] = useState(false);
            const [orderResult, setOrderResult] = useState(null);
            
            // 簽名板相關
            const [showSignatureModal, setShowSignatureModal] = useState(false); 
            const [signatureData, setSignatureData] = useState(null); 
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);
            const [modalHasSignature, setModalHasSignature] = useState(false); 

            // Line QR Code Modal 相關
            const [showLineQR, setShowLineQR] = useState(false);

            // 圖片預覽 Modal 相關狀態
            const [showImagePreview, setShowImagePreview] = useState(false);
            const [previewImageUrl, setPreviewImageUrl] = useState('');

            // 使用 Prod Key 確保資料是全新的
            const STORAGE_KEY = 'wufei_prod_v1_order'; 
            const DRAFT_KEY = 'wufei_prod_v1_draft';

            // 初始化：讀取 URL 參數與 LocalStorage
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const urlConsultant = {
                    name: params.get('c_name'),
                    id: params.get('c_id'),
                    location: params.get('loc')
                };

                let draftLoaded = false;

                // A. 檢查是否有已完成的訂單 (優先顯示成功頁面)
                try {
                    const savedOrder = localStorage.getItem(STORAGE_KEY);
                    if (savedOrder) {
                        const parsedOrder = JSON.parse(savedOrder);
                        // 檢查訂單是否過期 (24小時)
                        if (parsedOrder.deadline && parsedOrder.deadline > Date.now()) {
                            setOrderResult(parsedOrder);
                            setSubmitStatus('success');
                            setRestored(true); 
                            setCustomerInfo(parsedOrder.customer);
                            const finalConsultant = (!urlConsultant.name && !urlConsultant.id) 
                                ? parsedOrder.consultant 
                                : {
                                    name: urlConsultant.name || parsedOrder.consultant.name,
                                    id: urlConsultant.id || parsedOrder.consultant.id,
                                    location: urlConsultant.location || parsedOrder.consultant.location
                                };
                            setConsultantInfo(finalConsultant);
                            setCart(parsedOrder.items);
                            setSignatureData(parsedOrder.signature);
                            return; 
                        } else {
                            localStorage.removeItem(STORAGE_KEY); 
                        }
                    }
                } catch (error) {
                    console.error('Failed to load saved order:', error);
                    localStorage.removeItem(STORAGE_KEY);
                }

                // B. 檢查是否有草稿 (Draft)
                try {
                    const savedDraft = localStorage.getItem(DRAFT_KEY);
                    if (savedDraft) {
                        const draft = JSON.parse(savedDraft);
                        
                        setConsultantInfo(prev => ({
                            name: urlConsultant.name || draft.consultantInfo?.name || prev.name,
                            id: urlConsultant.id || draft.consultantInfo?.id || prev.id,
                            location: urlConsultant.location || draft.consultantInfo?.location || prev.location
                        }));

                        if (draft.customerInfo) setCustomerInfo(draft.customerInfo);
                        if (draft.cart) setCart(draft.cart);
                        if (draft.signatureData) setSignatureData(draft.signatureData);

                        draftLoaded = true;
                    }
                } catch (e) {
                    console.error("Draft load failed", e);
                }

                // C. 如果沒有草稿，僅套用 URL 參數
                if (!draftLoaded) {
                    setConsultantInfo(prev => ({
                        name: urlConsultant.name || prev.name,
                        id: urlConsultant.id || prev.id,
                        location: urlConsultant.location || prev.location
                    }));
                }

                const handleScroll = () => setScrolled(window.scrollY > 20);
                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            // 2. 自動儲存機制 (Auto-Save Effect)
            useEffect(() => {
                if (submitStatus !== 'success') {
                    const draftData = {
                        consultantInfo,
                        customerInfo,
                        cart,
                        signatureData,
                        updatedAt: Date.now()
                    };
                    localStorage.setItem(DRAFT_KEY, JSON.stringify(draftData));
                }
            }, [consultantInfo, customerInfo, cart, signatureData, submitStatus]);


            // 簽名板 Canvas 邏輯
            useEffect(() => {
                if (showSignatureModal) {
                    document.body.style.overflow = 'hidden';
                    setTimeout(initCanvas, 100);
                } else {
                    document.body.style.overflow = '';
                }
            }, [showSignatureModal]);

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas || !showSignatureModal) return;

                const preventDefault = (e) => {
                   if(e.target === canvas) e.preventDefault();
                }
                
                canvas.addEventListener('touchmove', preventDefault, { passive: false });
                canvas.addEventListener('touchstart', preventDefault, { passive: false });
                canvas.addEventListener('touchend', preventDefault, { passive: false });

                return () => {
                    canvas.removeEventListener('touchmove', preventDefault);
                    canvas.removeEventListener('touchstart', preventDefault);
                    canvas.removeEventListener('touchend', preventDefault);
                };
            }, [showSignatureModal]);


            const initCanvas = () => {
                const canvas = canvasRef.current;
                if (canvas) {
                    const parent = canvas.parentElement;
                    canvas.width = parent.clientWidth;
                    canvas.height = parent.clientHeight; 
                    const ctx = canvas.getContext('2d');
                    ctx.lineWidth = 3;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.strokeStyle = '#000000';
                    setModalHasSignature(false);
                }
            };

            const getPoint = (e, canvas) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };

            const startDrawing = (e) => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const { x, y } = getPoint(e, canvas);
                const ctx = canvas.getContext('2d');
                ctx.beginPath();
                ctx.moveTo(x, y);
                setIsDrawing(true);
            };

            const draw = (e) => {
                if (!isDrawing) return;
                const canvas = canvasRef.current;
                if (!canvas) return;
                const { x, y } = getPoint(e, canvas);
                const ctx = canvas.getContext('2d');
                ctx.lineTo(x, y);
                ctx.stroke();
                if (!modalHasSignature) setModalHasSignature(true);
            };

            const stopDrawing = () => setIsDrawing(false);
            const clearCanvas = () => {
                const canvas = canvasRef.current;
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    setModalHasSignature(false);
                }
            };
            const confirmSignature = () => {
                const canvas = canvasRef.current;
                if (canvas && modalHasSignature) {
                    setSignatureData(canvas.toDataURL());
                    setShowSignatureModal(false);
                } else {
                    alert('請先進行簽名');
                }
            };

            // 表單處理
            const handleConsultantChange = (e) => {
                const { name, value } = e.target;
                setConsultantInfo(prev => ({ ...prev, [name]: value }));
                if (errors[`consultant_${name}`]) {
                    setErrors(prev => ({ ...prev, [`consultant_${name}`]: false }));
                }
            };

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                
                // 生日欄位特殊處理：只允許輸入數字，最多8碼
                if (name === 'birthday') {
                    const numericValue = value.replace(/\D/g, '').slice(0, 8);
                    setCustomerInfo(prev => ({ ...prev, [name]: numericValue }));
                    if (errors[`customer_${name}`]) {
                        setErrors(prev => ({ ...prev, [`customer_${name}`]: false }));
                    }
                } else {
                    setCustomerInfo(prev => ({ ...prev, [name]: value }));
                    if (errors[`customer_${name}`]) {
                        setErrors(prev => ({ ...prev, [`customer_${name}`]: false }));
                    }
                }
            };

            const toggleExpand = (id) => setExpandedCards(prev => ({ ...prev, [id]: !prev[id] }));
            
            const updateQuantity = (id, delta) => {
                setCart(prev => {
                    const currentQty = prev[id] || 0;
                    const newQty = Math.max(0, currentQty + delta);
                    const newCart = { ...prev };
                    if (newQty === 0) delete newCart[id];
                    else newCart[id] = newQty;
                    return newCart;
                });
            };

            const calculateTotal = () => {
                return Object.entries(cart).reduce((total, [id, qty]) => {
                    const product = initialProducts.find(p => p.id === parseInt(id));
                    return total + (product ? product.price * qty : 0);
                }, 0);
            };

            const generateOrderId = () => {
                const date = new Date();
                const dateStr = date.toISOString().slice(0,10).replace(/-/g, '');
                const random = Math.floor(Math.random() * 9000 + 1000);
                return `WFB-${dateStr}-${random}`;
            };

            const sendToGoogleSheets = async (finalOrder) => {
                if (!GOOGLE_SCRIPT_URL) return;

                const itemsSummary = Object.entries(finalOrder.items).map(([id, qty]) => {
                    const product = initialProducts.find(p => p.id === parseInt(id));
                    return `${product.name} x${qty}`;
                }).join(", ");

                const payload = { ...finalOrder, itemsSummary };

                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload),
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' }
                    });
                    console.log('Order sent to Google Sheets');
                } catch (error) {
                    console.error('Error sending order:', error);
                }
            };

            // 取得輸入框樣式
            const getInputClass = (isError) => {
                const baseClass = "w-full p-3 rounded-xl border outline-none transition-all placeholder:text-gray-400";
                if (isError) {
                    return `${baseClass} border-red-500 ring-2 ring-red-500/20 bg-red-50 text-red-900`;
                }
                return `${baseClass} border-gray-200 focus:border-purple-500 bg-white`;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                // 1. 驗證必填欄位
                const newErrors = {};
                if (!consultantInfo.name) newErrors.consultant_name = true;
                if (!consultantInfo.id) newErrors.consultant_id = true;
                if (!consultantInfo.location) newErrors.consultant_location = true;
                
                if (!customerInfo.name) newErrors.customer_name = true;
                if (!customerInfo.phone) newErrors.customer_phone = true;
                if (!customerInfo.email) newErrors.customer_email = true;
                if (!customerInfo.source) newErrors.customer_source = true;

                // 生日欄位驗證：如果有填寫，必須是 8 位數
                if (customerInfo.birthday && customerInfo.birthday.length !== 8) {
                    newErrors.customer_birthday = true;
                    alert("生日格式錯誤！請輸入完整的 8 位數西元生日 (例如 19900101)");
                }

                // 2. 錯誤處理與捲動
                if (Object.keys(newErrors).length > 0) {
                    setErrors(newErrors);
                    const firstErrorId = Object.keys(newErrors)[0];
                    const element = document.getElementById(firstErrorId);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        element.focus();
                    }
                    return;
                }

                // 3. 其他驗證
                if (calculateTotal() === 0) { alert("請至少選擇一項服務！"); return; }
                if (!signatureData) { alert("請完成客戶簽名！"); return; }
                
                setIsSubmitting(true);
                
                const orderId = generateOrderId();
                const deadline = Date.now() + 24 * 60 * 60 * 1000; 
                const finalOrder = {
                    id: orderId,
                    consultant: consultantInfo,
                    customer: customerInfo,
                    items: cart,
                    total: calculateTotal(),
                    date: new Date().toLocaleString('zh-TW'),
                    signature: signatureData,
                    deadline: deadline
                };
                
                sendToGoogleSheets(finalOrder);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(finalOrder)); 
                localStorage.removeItem(DRAFT_KEY);

                setTimeout(() => {
                    setOrderResult(finalOrder);
                    setIsSubmitting(false);
                    setSubmitStatus('success');
                    setRestored(false); 
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }, 1500);
            };

            const handleBackToEdit = () => { setSubmitStatus(null); window.scrollTo({ top: 0, behavior: 'smooth' }); };
            
            const handleNewOrder = () => {
                if (confirm('確定要建立新的一張訂單嗎？\n(將清除目前的客戶資料與簽名，但保留顧問資料)')) {
                    localStorage.removeItem(STORAGE_KEY);
                    localStorage.removeItem(DRAFT_KEY);
                    
                    setCustomerInfo({ 
                        name: '', phone: '', birthday: '', email: '', 
                        address: '', company: '', taxId: '', source: '', notes: '' 
                    });
                    setCart({});
                    setSignatureData(null);
                    setOrderResult(null);
                    setSubmitStatus(null);
                    setRestored(false);
                    setErrors({});
                    setExpandedCards({});

                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            // 訂單確認文字生成
            const generateOrderText = (order) => {
                if (!order) return '';
                const itemsList = Object.entries(order.items).map(([id, qty]) => {
                    const product = initialProducts.find(p => p.id === parseInt(id));
                    return `• ${product.name} x ${qty} = NT$ ${(product.price * qty).toLocaleString()}`;
                }).join('\n');

                const addressInfo = order.customer.address ? `\n[地址] ${order.customer.address}` : '';

                return `【吾飛藝術銀行 - 訂單確認】\n訂單編號：${order.id}\n------------------------\n[服務顧問]\n姓名：${order.consultant.name} (${order.consultant.id})\n據點：${order.consultant.location}\n------------------------\n[客戶] ${order.customer.name} / ${order.customer.phone}${addressInfo}\n[來源] ${order.customer.source || '無'}\n------------------------\n[訂購項目]\n${itemsList}\n------------------------\n總金額：NT$ ${order.total.toLocaleString()}\n\n* 請協助確認款項，謝謝！`;
            };

            // 強化版複製功能 (silent 參數)
            const copyToClipboard = async (text, silent = false) => {
                try {
                    await navigator.clipboard.writeText(text);
                    if (!silent) alert('複製成功！');
                } catch (err) {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-9999px";
                    textArea.style.top = "0";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        const successful = document.execCommand('copy');
                        if (successful) {
                            if (!silent) alert('複製成功！');
                        } else {
                            if (!silent) alert('複製失敗，請手動長按選取文字複製。');
                        }
                    } catch (fallbackErr) {
                        console.error('Copy failed', fallbackErr);
                        if (!silent) alert('複製失敗，請嘗試使用截圖功能。');
                    }
                    document.body.removeChild(textArea);
                }
            };

            // 點擊「傳送訂單給客服」的處理邏輯
            const handleShowLineQR = async () => {
                if (!orderResult) return;
                const text = generateOrderText(orderResult);
                await copyToClipboard(text, true); // Silent mode
                setShowLineQR(true);
            };

            // 分享功能
            const handleShare = async () => {
                if (!orderResult) return;
                const text = generateOrderText(orderResult);
                
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: '吾飛藝術銀行 - 訂單確認',
                            text: text,
                        });
                    } catch (err) {
                        console.log('Error sharing', err);
                    }
                } else {
                    copyToClipboard(text);
                }
            };

            // 圖片預覽功能
            const downloadReceiptImage = () => {
                const receiptElement = document.getElementById('receipt-card');
                if (!receiptElement) return;
                
                const btnTextElement = document.getElementById('download-btn-text');
                const originalBtnText = btnTextElement.innerText;
                btnTextElement.innerText = "生成中...";

                html2canvas(receiptElement, { scale: 3, backgroundColor: '#ffffff', useCORS: true }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    setPreviewImageUrl(imgData);
                    setShowImagePreview(true); 
                    btnTextElement.innerText = originalBtnText;
                }).catch((err) => {
                    console.error("Screenshot error:", err);
                    alert('圖片生成失敗，請嘗試手動截圖。');
                    btnTextElement.innerText = originalBtnText;
                });
            };

            if (submitStatus === 'success' && orderResult) {
                return (
                    <div className="min-h-screen bg-[#f5f5f7] pb-20">
                        <div className="max-w-xl mx-auto bg-white min-h-screen shadow-2xl overflow-hidden flex flex-col">
                            {/* 成功頁面 Header */}
                            <div className="bg-[#1d1d1f] text-white p-8 text-center rounded-b-[2rem] shadow-lg relative z-10">
                                <div className="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-green-500/30">
                                    <Check className="w-8 h-8 text-white stroke-[3]" />
                                </div>
                                <h2 className="text-2xl font-bold mb-1">{restored ? '訂單已恢復' : '訂單已送出'}</h2>
                                <p className="text-gray-400 text-xs">請完成付款並傳送資料至官方 Line 確認</p>
                            </div>
                            
                            <div className="px-6 -mt-6 relative z-20 flex-grow">
                                {restored && (
                                    <div className="mb-4 bg-blue-50 border border-blue-200 text-blue-800 px-4 py-2 rounded-xl flex items-center gap-2 text-sm shadow-sm">
                                        <AlertCircle className="w-4 h-4" /> 這是您尚未清除的歷史訂單
                                    </div>
                                )}
                                
                                {/* 訂單摘要卡片 */}
                                <div id="receipt-card" className="bg-white rounded-xl shadow-xl border border-gray-100 overflow-hidden mb-6">
                                    <div className="bg-gray-50 border-b border-gray-100 p-4 flex justify-between items-center">
                                        <span className="text-xs font-bold text-gray-400 uppercase">Order ID</span>
                                        <span className="font-mono font-bold text-[#1d1d1f]">{orderResult.id}</span>
                                    </div>
                                    <div className="p-6 space-y-4">
                                        {/* 客戶資料區塊 */}
                                        <div className="text-sm border-b border-dashed border-gray-200 pb-4 space-y-3">
                                            {/* Row 1: 姓名、電話 */}
                                            <div className="grid grid-cols-2 gap-2">
                                                <div><p className="text-xs text-gray-400">客戶姓名</p><p className="font-medium text-[#1d1d1f]">{orderResult.customer.name}</p></div>
                                                <div><p className="text-xs text-gray-400">聯絡電話</p><p className="font-medium text-[#1d1d1f]">{orderResult.customer.phone}</p></div>
                                            </div>
                                            {/* Row 2: 生日、統編 */}
                                            <div className="grid grid-cols-2 gap-2">
                                                <div><p className="text-xs text-gray-400">生日</p><p className="font-medium text-[#1d1d1f]">{orderResult.customer.birthday || '-'}</p></div>
                                                <div><p className="text-xs text-gray-400">統編</p><p className="font-medium text-[#1d1d1f]">{orderResult.customer.taxId || '-'}</p></div>
                                            </div>
                                            {/* Row 3: 公司、來源 */}
                                            <div className="grid grid-cols-2 gap-2">
                                                <div><p className="text-xs text-gray-400">公司</p><p className="font-medium text-[#1d1d1f]">{orderResult.customer.company || '-'}</p></div>
                                                <div><p className="text-xs text-gray-400">資訊來源</p><p className="font-medium text-[#6d28d9]">{orderResult.customer.source || '-'}</p></div>
                                            </div>
                                            {/* Row 4: 信箱 (獨立一行，防止切斷) */}
                                            <div>
                                                <p className="text-xs text-gray-400">信箱</p>
                                                <p className="font-medium text-[#1d1d1f] break-all">{orderResult.customer.email}</p>
                                            </div>
                                            {/* Row 5: 地址 (獨立一行) */}
                                            <div>
                                                <p className="text-xs text-gray-400">地址</p>
                                                <p className="font-medium text-[#1d1d1f] break-words">{orderResult.customer.address || '-'}</p>
                                            </div>
                                        </div>

                                        {/* 訂購項目 */}
                                        <div>
                                            <p className="text-xs text-gray-400 mb-2">訂購項目</p>
                                            <ul className="space-y-2">
                                                {Object.entries(orderResult.items).map(([id, qty]) => {
                                                    const product = initialProducts.find(p => p.id === parseInt(id));
                                                    return (
                                                        <li key={id} className="flex justify-between text-sm">
                                                            <span className="text-gray-600">{product.name} <span className="text-gray-400 text-xs">x{qty}</span></span>
                                                            <span className="font-medium">NT$ {(product.price * qty).toLocaleString()}</span>
                                                        </li>
                                                    );
                                                })}
                                            </ul>
                                        </div>
                                        <div className="pt-4 border-t border-gray-200 flex justify-between items-end">
                                            {/* 顧問資訊 */}
                                            <div>
                                                <p className="text-xs text-gray-400">服務顧問</p>
                                                <p className="text-sm font-medium">{orderResult.consultant.name} <span className="text-xs text-gray-500">({orderResult.consultant.id})</span></p>
                                                <p className="text-xs text-gray-500">{orderResult.consultant.location}</p>
                                            </div>
                                            <div className="text-right"><p className="text-xs text-gray-400">總金額 (含稅)</p><p className="text-2xl font-bold text-[#1d1d1f]">NT$ {orderResult.total.toLocaleString()}</p></div>
                                        </div>
                                    </div>
                                    <div className="bg-gray-50 p-3 flex border-t border-gray-100" data-html2canvas-ignore>
                                        <button onClick={downloadReceiptImage} className="flex-1 flex items-center justify-center gap-2 text-blue-600 text-xs font-bold border-r border-gray-200"><ImageIcon className="w-4 h-4" /> <span id="download-btn-text">下載圖片</span></button>
                                        <button onClick={() => copyToClipboard(generateOrderText(orderResult), false)} className="flex-1 flex items-center justify-center gap-2 text-[#6d28d9] text-xs font-bold border-r border-gray-200"><Copy className="w-4 h-4" /> 複製文字</button>
                                        <button onClick={handleShare} className="flex-1 flex items-center justify-center gap-2 text-[#1d1d1f] text-xs font-bold hover:text-gray-600"><Share2 className="w-4 h-4" /> 分享</button>
                                    </div>
                                </div>

                                {/* 付款資訊 */}
                                <div className="bg-white rounded-xl border border-red-100 p-4 mb-6 shadow-sm relative">
                                    <div className="absolute top-0 right-0 bg-red-50 text-red-600 text-[10px] font-bold px-2 py-1 rounded-bl-lg border-l border-b border-red-100">待付款</div>
                                    <h3 className="font-bold text-[#1d1d1f] mb-3 flex items-center gap-2 text-sm"><CreditCard className="w-4 h-4 text-gray-400" /> 付款資訊</h3>
                                    <div className="bg-red-50 rounded p-2 mb-3 flex items-center justify-between text-xs text-red-700">
                                        <div className="flex items-center gap-1"><Clock className="w-3 h-3" /> 匯款剩餘時間</div>
                                        <CountdownTimer deadline={orderResult.deadline} />
                                    </div>
                                    <div className="space-y-1 text-xs text-gray-600">
                                        <div className="flex justify-between"><span>銀行</span><span className="font-mono font-bold text-black">822 (中國信託)</span></div>
                                        <div className="flex justify-between"><span>帳號</span><span className="font-mono font-bold text-black">1234-5678-9012</span></div>
                                    </div>
                                </div>

                                {/* 操作按鈕 */}
                                <div className="space-y-3 pb-8">
                                    <button onClick={handleShowLineQR} className="w-full py-4 rounded-xl bg-[#06C755] hover:bg-[#05b54d] text-white font-bold flex items-center justify-center gap-2 shadow-lg shadow-green-500/20 active:scale-95 transition-transform">
                                        <MessageCircle className="w-5 h-5 fill-current" /> 傳送訂單給客服 (Line)
                                    </button>
                                    <div className="grid grid-cols-2 gap-3">
                                        <button onClick={handleBackToEdit} className="py-3 rounded-xl bg-gray-100 text-gray-700 text-xs font-bold flex items-center justify-center gap-1"><ArrowLeft className="w-3 h-3" /> 返回修改</button>
                                        <button onClick={handleNewOrder} className="py-3 rounded-xl bg-white border border-gray-200 text-gray-600 text-xs font-bold flex items-center justify-center gap-1"><RefreshCw className="w-3 h-3" /> 建立新單</button>
                                    </div>
                                </div>
                            </div>

                            {/* Line QR Code Modal */}
                            {showLineQR && (
                                <div className="fixed inset-0 z-[70] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">
                                    <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 text-center space-y-6 relative animate-scale-in">
                                        <button 
                                            onClick={() => setShowLineQR(false)}
                                            className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"
                                        >
                                            <X className="w-6 h-6" />
                                        </button>
                                        
                                        <div>
                                            <div className="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                                <QrCode className="w-6 h-6 text-[#06C755]" />
                                            </div>
                                            <h3 className="text-xl font-bold text-[#1d1d1f]">加入官方帳號</h3>
                                            <p className="text-sm text-gray-500 mt-2">訂單資料已自動複製！<br/>請掃描或點擊下方按鈕加入好友，<br/>並在聊天室<span className="font-bold text-green-600">「貼上」</span>即可傳送。</p>
                                        </div>

                                        <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 inline-block">
                                            {/* 使用 Google Chart API 生成一個 QR Code 佔位符 */}
                                            <img 
                                                src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=https://line.me/R/ti/p/@324vsvvv" 
                                                alt="Line QR Code" 
                                                className="w-40 h-40 mix-blend-multiply"
                                            />
                                        </div>

                                        <a 
                                            href="https://line.me/R/ti/p/@324vsvvv" 
                                            target="_blank"
                                            className="w-full py-3 rounded-xl bg-[#06C755] hover:bg-[#05b54d] text-white font-bold flex items-center justify-center gap-2 shadow-lg shadow-green-500/20"
                                        >
                                            開啟 LINE App <ArrowLeft className="w-4 h-4 rotate-180" />
                                        </a>
                                    </div>
                                </div>
                            )}

                            {/* 新增：圖片預覽與儲存 Modal */}
                            {showImagePreview && (
                                <div className="fixed inset-0 z-[80] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in" onClick={() => setShowImagePreview(false)}>
                                    <div className="relative max-w-sm w-full" onClick={e => e.stopPropagation()}>
                                        <div className="bg-white rounded-2xl overflow-hidden shadow-2xl p-2">
                                            <div className="flex justify-between items-center p-2 mb-2 border-b border-gray-100">
                                                <h3 className="font-bold text-sm text-gray-600 flex items-center gap-2">
                                                    <ImageIcon className="w-4 h-4" /> 長按圖片即可儲存
                                                </h3>
                                                <button onClick={() => setShowImagePreview(false)} className="p-1 rounded-full hover:bg-gray-100">
                                                    <X className="w-5 h-5 text-gray-400" />
                                                </button>
                                            </div>
                                            <div className="bg-gray-50 rounded-xl overflow-hidden border border-gray-200">
                                                <img src={previewImageUrl} alt="Order Receipt" className="w-full h-auto" />
                                            </div>
                                            <p className="text-center text-xs text-gray-400 mt-3 mb-1">
                                                請長按上方圖片並選擇「加入照片」或「儲存影像」
                                            </p>
                                        </div>
                                        <button 
                                            onClick={() => setShowImagePreview(false)}
                                            className="mt-4 w-full py-3 rounded-xl bg-white/20 text-white font-bold backdrop-blur-md border border-white/30 hover:bg-white/30 transition-colors"
                                        >
                                            關閉預覽
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-[#f5f5f7] font-sans pb-32">
                    {/* Top Bar */}
                    <div className={`fixed top-0 left-0 right-0 z-50 transition-all duration-300 ${scrolled ? 'bg-white/80 backdrop-blur-md border-b border-gray-200/50' : ''}`}>
                        <div className="max-w-3xl mx-auto px-6 py-4 flex items-center justify-between">
                            <div className="flex items-center gap-2 font-semibold text-[#1d1d1f]">
                                <span className="w-8 h-8 bg-gradient-to-tr from-purple-600 to-indigo-600 rounded-lg text-white flex items-center justify-center shadow-lg shadow-purple-500/20"><Sparkles className="w-4 h-4" /></span>
                                吾飛藝術銀行
                            </div>
                            
                            {/* Visual Indicator for Draft */}
                            <div className="text-[10px] text-gray-400 flex items-center gap-1">
                                <Save className="w-3 h-3" /> 草稿已自動暫存
                            </div>
                        </div>
                    </div>

                    <div className="pt-28 pb-10 px-6 text-center max-w-xl mx-auto">
                        <h1 className="text-3xl font-bold text-[#1d1d1f] mb-2">會員服務訂購單</h1>
                        <p className="text-gray-500 text-sm">盤點過去，啟動未來無限潛能。</p>
                    </div>

                    <div className="max-w-xl mx-auto px-6 space-y-8">
                        {/* 顧問資料 (標示必填) */}
                        <section className="space-y-4">
                            <h3 className="text-lg font-bold border-b border-gray-200 pb-2 text-[#1d1d1f]">服務顧問</h3>
                            <div className="grid grid-cols-2 gap-3">
                                <div className="space-y-1">
                                    <label className="text-xs text-gray-400">顧問姓名 <span className="text-red-500">*</span></label>
                                    <input 
                                        id="consultant_name"
                                        type="text" 
                                        name="name" 
                                        value={consultantInfo.name} 
                                        onChange={handleConsultantChange} 
                                        className={getInputClass(errors.consultant_name)}
                                        placeholder="請輸入 *" 
                                    />
                                </div>
                                <div className="space-y-1">
                                    <label className="text-xs text-gray-400">顧問編號 <span className="text-red-500">*</span></label>
                                    <input 
                                        id="consultant_id"
                                        type="text" 
                                        name="id" 
                                        value={consultantInfo.id} 
                                        onChange={handleConsultantChange} 
                                        className={getInputClass(errors.consultant_id)}
                                        placeholder="C001 *" 
                                    />
                                </div>
                                <div className="col-span-2 space-y-1">
                                    <label className="text-xs text-gray-400">服務據點 <span className="text-red-500">*</span></label>
                                    <div className="relative">
                                        <select 
                                            id="consultant_location"
                                            name="location" 
                                            value={consultantInfo.location} 
                                            onChange={handleConsultantChange} 
                                            className={`${getInputClass(errors.consultant_location)} appearance-none`}
                                        >
                                            <option value="桃園館">桃園館</option>
                                            <option value="大安館">大安館</option>
                                        </select>
                                        <ChevronDown className="absolute right-3 top-3.5 w-4 h-4 text-gray-400 pointer-events-none" />
                                    </div>
                                </div>
                            </div>
                        </section>

                        {/* 客戶資料 (標示必填) */}
                        <section className="space-y-4">
                            <h3 className="text-lg font-bold border-b border-gray-200 pb-2 text-[#1d1d1f]">客戶資料</h3>
                            <div className="space-y-3">
                                {/* Row 1: 姓名、電話 */}
                                <div className="grid grid-cols-2 gap-3">
                                    <input 
                                        id="customer_name"
                                        type="text" 
                                        name="name" 
                                        value={customerInfo.name} 
                                        onChange={handleInputChange} 
                                        placeholder="客戶姓名 *" 
                                        className={getInputClass(errors.customer_name)} 
                                    />
                                    <input 
                                        id="customer_phone"
                                        type="tel" 
                                        name="phone" 
                                        value={customerInfo.phone} 
                                        onChange={handleInputChange} 
                                        placeholder="聯絡電話 *" 
                                        className={getInputClass(errors.customer_phone)} 
                                    />
                                </div>
                                
                                {/* Row 2: 生日、信箱 */}
                                <div className="grid grid-cols-2 gap-3">
                                    <input 
                                        id="customer_birthday"
                                        type="tel" 
                                        name="birthday" 
                                        value={customerInfo.birthday} 
                                        onChange={handleInputChange} 
                                        maxLength={8}
                                        placeholder="生日 (YYYYMMDD) *" 
                                        className={getInputClass(errors.customer_birthday)} 
                                    />
                                    <input 
                                        id="customer_email"
                                        type="email" 
                                        name="email" 
                                        value={customerInfo.email} 
                                        onChange={handleInputChange} 
                                        placeholder="信箱 *" 
                                        className={getInputClass(errors.customer_email)} 
                                    />
                                </div>

                                {/* Row 3: 地址 */}
                                <div>
                                    <input 
                                        type="text" 
                                        name="address" 
                                        value={customerInfo.address} 
                                        onChange={handleInputChange} 
                                        placeholder="地址" 
                                        className="w-full p-4 rounded-xl border border-gray-200 outline-none focus:border-purple-500 bg-white placeholder-gray-400" 
                                    />
                                </div>

                                {/* Row 4: 公司、統編 */}
                                <div className="grid grid-cols-2 gap-3">
                                    <input 
                                        type="text" 
                                        name="company" 
                                        value={customerInfo.company} 
                                        onChange={handleInputChange} 
                                        placeholder="公司名稱" 
                                        className="w-full p-4 rounded-xl border border-gray-200 outline-none focus:border-purple-500 bg-white placeholder-gray-400" 
                                    />
                                    <input 
                                        type="text" 
                                        name="taxId" 
                                        value={customerInfo.taxId} 
                                        onChange={handleInputChange} 
                                        placeholder="統一編號" 
                                        className="w-full p-4 rounded-xl border border-gray-200 outline-none focus:border-purple-500 bg-white placeholder-gray-400" 
                                    />
                                </div>

                                {/* Row 5: 來源 */}
                                <div className="relative">
                                    <Info className="absolute left-4 top-4 w-5 h-5 text-purple-600" />
                                    <input 
                                        id="customer_source"
                                        type="text" 
                                        name="source" 
                                        value={customerInfo.source} 
                                        onChange={handleInputChange} 
                                        placeholder="資訊來源 (例: 網路搜尋) *" 
                                        className={`${getInputClass(errors.customer_source)} pl-12`} 
                                    />
                                </div>
                            </div>
                        </section>

                        {/* 產品選擇 */}
                        <section className="space-y-4">
                            <h3 className="text-lg font-bold border-b border-gray-200 pb-2 text-[#1d1d1f]">選擇服務方案</h3>
                            <div className="space-y-4">
                                {initialProducts.map((product) => {
                                    const qty = cart[product.id] || 0;
                                    const isSelected = qty > 0;
                                    const isExpanded = expandedCards[product.id];
                                    return (
                                        <div key={product.id} onClick={() => toggleExpand(product.id)} className={`bg-white rounded-3xl transition-all duration-300 cursor-pointer overflow-hidden relative ${isSelected ? 'ring-2 ring-purple-600 shadow-lg' : 'border border-gray-100 shadow-sm'}`}>
                                            {product.popular && <div className="absolute top-0 right-0 bg-purple-600 text-white text-[10px] font-bold px-3 py-1 rounded-bl-xl z-10">POPULAR</div>}
                                            <div className="p-6 flex items-center justify-between">
                                                <div className="flex items-center gap-4">
                                                    <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-white bg-gradient-to-br ${product.color}`}>{product.icon}</div>
                                                    <div>
                                                        <div className="text-[10px] text-gray-400 font-bold uppercase tracking-wider">{product.subName}</div>
                                                        <div className="text-lg font-bold text-[#1d1d1f]">{product.name}</div>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    {!isSelected && <div className="text-right hidden sm:block"><div className="font-bold">NT$ {product.price.toLocaleString()}</div></div>}
                                                    <ChevronDown className={`w-5 h-5 text-gray-400 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
                                                </div>
                                            </div>
                                            <div className={`bg-gray-50 overflow-hidden transition-all duration-300 ${isExpanded ? 'max-h-96 opacity-100' : 'max-h-0 opacity-0'}`}>
                                                <div className="p-6 pt-2">
                                                    <p className="text-sm text-gray-600 mb-4">{product.description}</p>
                                                    <div className="space-y-2 mb-4">{product.features.map((f, i) => <div key={i} className="flex items-center gap-2 text-xs text-gray-500"><Check className="w-3 h-3 text-purple-600" /> {f}</div>)}</div>
                                                    <div className="flex justify-between items-center bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                                                        <div><div className="text-xs text-gray-400">費用</div><div className="font-bold text-lg">NT$ {product.price.toLocaleString()}</div></div>
                                                        {qty === 0 ? (
                                                            <button onClick={(e) => { e.stopPropagation(); updateQuantity(product.id, 1); }} className="bg-[#1d1d1f] text-white px-6 py-2 rounded-full text-sm font-bold shadow-lg">購買</button>
                                                        ) : (
                                                            <div className="flex items-center gap-3 bg-[#f5f5f7] rounded-full p-1"><button onClick={(e) => { e.stopPropagation(); updateQuantity(product.id, -1); }} className="w-8 h-8 bg-white rounded-full flex items-center justify-center shadow-sm"><Minus className="w-3 h-3" /></button><span className="font-bold w-4 text-center">{qty}</span><button onClick={(e) => { e.stopPropagation(); updateQuantity(product.id, 1); }} className="w-8 h-8 bg-[#1d1d1f] text-white rounded-full flex items-center justify-center shadow-sm"><Plus className="w-3 h-3" /></button></div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </section>

                        {/* 簽名板 */}
                        <section>
                            <h3 className="text-lg font-bold border-b border-gray-200 pb-2 text-[#1d1d1f] mb-4">客戶簽名</h3>
                            <div className="bg-white rounded-2xl border-2 border-dashed border-gray-300 p-6 flex flex-col items-center justify-center min-h-[140px] relative overflow-hidden">
                                {signatureData ? (
                                    <div className="flex flex-col items-center w-full">
                                        <img src={signatureData} alt="Sign" className="h-20 mb-3 object-contain" />
                                        <div className="flex gap-3">
                                            <button 
                                                onClick={() => setShowSignatureModal(true)} 
                                                className="text-xs text-purple-600 font-bold bg-purple-50 px-4 py-2 rounded-lg flex items-center gap-1 hover:bg-purple-100 transition-colors"
                                            >
                                                <Edit3 className="w-3 h-3" /> 重簽
                                            </button>
                                            {/* 新增：刪除簽名按鈕 */}
                                            <button 
                                                onClick={() => setSignatureData(null)} 
                                                className="text-xs text-red-500 font-bold bg-red-50 px-4 py-2 rounded-lg flex items-center gap-1 hover:bg-red-100 transition-colors"
                                            >
                                                <Trash2 className="w-3 h-3" /> 刪除
                                            </button>
                                        </div>
                                    </div>
                                ) : (
                                    <button onClick={() => setShowSignatureModal(true)} className="w-full h-full absolute inset-0 flex flex-col items-center justify-center text-gray-400 hover:bg-gray-50 transition-colors">
                                        <PenTool className="w-6 h-6 mb-2" />
                                        <span className="text-sm font-medium">點此開啟簽名板</span>
                                    </button>
                                )}
                            </div>
                            {/* 新增個資聲明 */}
                            <div className="mt-4 flex gap-3 p-3 bg-gray-50 rounded-xl text-xs text-gray-500 leading-relaxed border border-gray-100">
                                <ShieldCheck className="w-4 h-4 flex-shrink-0 text-gray-400 mt-0.5" />
                                <div>
                                    <p>1. 以上資料皆用於公司內部建檔及紀錄。</p>
                                    <p className="mt-1">2. 公司嚴格遵守隱私權、個資保護。</p>
                                    <p className="mt-1">3. 本公司絕不向第三方揭露您的任何資訊，並確認以上填寫資料無誤。</p>
                                </div>
                            </div>
                        </section>
                    </div>

                    {/* Footer CTA */}
                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-5 z-40">
                        <div className="max-w-3xl mx-auto flex items-center justify-between">
                            <div><div className="text-[10px] text-gray-400 uppercase tracking-wider">Total</div><div className="text-2xl font-bold text-[#1d1d1f]">NT$ {calculateTotal().toLocaleString()}</div></div>
                            <button onClick={handleSubmit} disabled={isSubmitting} className={`px-8 py-3 rounded-full font-bold flex items-center gap-2 shadow-xl ${isSubmitting ? 'bg-gray-200 text-gray-400' : 'bg-[#1d1d1f] text-white hover:bg-black'}`}>
                                {isSubmitting ? <Loader2 className="w-4 h-4 animate-spin" /> : <><Send className="w-4 h-4" /> 送出訂購單</>}
                            </button>
                        </div>
                    </div>

                    {/* Signature Modal */}
                    {showSignatureModal && (
                        <div className="fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm flex items-end sm:items-center justify-center">
                            <div className="bg-white w-full sm:max-w-lg sm:rounded-2xl rounded-t-2xl flex flex-col h-[85vh] sm:h-[600px] animate-slide-up">
                                <div className="p-4 border-b flex justify-between items-center"><h3 className="font-bold">請簽名</h3><button onClick={() => setShowSignatureModal(false)}><X className="w-6 h-6 text-gray-400" /></button></div>
                                <div className="flex-1 bg-[#f5f5f7] relative m-4 rounded-xl border-2 border-dashed border-gray-300 touch-none overflow-hidden">
                                    <canvas 
                                        ref={canvasRef} 
                                        onMouseDown={startDrawing} 
                                        onMouseMove={draw} 
                                        onMouseUp={stopDrawing} 
                                        onMouseLeave={stopDrawing}
                                        onTouchStart={startDrawing}
                                        onTouchMove={draw}
                                        onTouchEnd={stopDrawing}
                                        className="block w-full h-full cursor-crosshair" 
                                    />
                                    {!modalHasSignature && !isDrawing && <div className="absolute inset-0 flex items-center justify-center pointer-events-none text-gray-400 gap-2"><PenTool className="w-5 h-5" /> 請在此區域簽名</div>}
                                </div>
                                <div className="p-4 border-t flex gap-3">
                                    <button onClick={clearCanvas} className="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-600 flex justify-center gap-2"><Eraser className="w-4 h-4" /> 清除</button>
                                    <button onClick={confirmSignature} className="flex-[2] py-3 bg-[#1d1d1f] text-white rounded-xl font-bold flex justify-center gap-2 shadow-lg"><Check className="w-4 h-4" /> 確認</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<OrderForm />);
    </script>
</body>
</html>