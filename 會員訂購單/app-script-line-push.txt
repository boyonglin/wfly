/**
 * Google Apps Script - LINE Push Message ä»£ç†
 * =============================================
 * é€™å€‹è…³æœ¬ç”¨æ–¼å®‰å…¨åœ°è™•ç† LINE Push Message
 * é¿å…å°‡ CHANNEL_ACCESS_TOKEN æš´éœ²åœ¨å‰ç«¯
 *
 * ã€è¨­å®šæ­¥é©Ÿã€‘
 * 1. åˆ° Google Apps Script (script.google.com) å»ºç«‹æ–°å°ˆæ¡ˆ
 * 2. è²¼ä¸Šæ­¤ç¨‹å¼ç¢¼
 * 3. è¨­å®šè…³æœ¬å±¬æ€§ï¼š
 *    - é»æ“Šã€Œè¨­å®šã€(é½’è¼ªåœ–ç¤º) > ã€Œè…³æœ¬å±¬æ€§ã€
 *    - æ–°å¢å±¬æ€§ï¼šLINE_CHANNEL_ACCESS_TOKEN = ä½ çš„ Token
 * 4. éƒ¨ç½²ç‚ºç¶²è·¯æ‡‰ç”¨ç¨‹å¼ï¼š
 *    - åŸ·è¡Œç‚ºï¼šæˆ‘è‡ªå·±
 *    - èª°å¯å­˜å–ï¼šä»»ä½•äºº
 * 5. è¤‡è£½éƒ¨ç½²çš„ URL åˆ° config.js çš„ PUSH_API_ENDPOINT
 */

// LINE Messaging API Endpoint
const LINE_PUSH_API = 'https://api.line.me/v2/bot/message/push';

/**
 * è™•ç† POST è«‹æ±‚
 * @param {Object} e - è«‹æ±‚äº‹ä»¶ç‰©ä»¶
 */
function doPost(e) {
  try {
    // å–å¾— Channel Access Tokenï¼ˆå¾è…³æœ¬å±¬æ€§ä¸­å–å¾—ï¼Œå®‰å…¨æ€§è¼ƒé«˜ï¼‰
    const props = PropertiesService.getScriptProperties();
    const channelAccessToken = props.getProperty('LINE_CHANNEL_ACCESS_TOKEN');

    if (!channelAccessToken) {
      return createResponse(500, { error: 'Server configuration error: Missing LINE_CHANNEL_ACCESS_TOKEN' });
    }

    // è§£æè«‹æ±‚åƒæ•¸
    const params = JSON.parse(e.postData.contents);
    const { action, userId, message, flexMessage } = params;

    // é©—è­‰å¿…è¦åƒæ•¸
    if (!userId) {
      return createResponse(400, { error: 'Missing required parameter: userId' });
    }

    let result;

    switch (action) {
      case 'pushText':
        // ç™¼é€ç´”æ–‡å­—è¨Šæ¯
        result = pushTextMessage(channelAccessToken, userId, message);
        break;

      case 'pushFlex':
        // ç™¼é€ Flex Messageï¼ˆè¨‚å–®å¡ç‰‡ï¼‰
        result = pushFlexMessage(channelAccessToken, userId, flexMessage);
        break;

      case 'pushOrderCard':
        // ç™¼é€è¨‚å–®å¡ç‰‡ï¼ˆé è¨­æ ¼å¼ï¼‰
        const orderData = params.orderData;
        result = pushOrderCard(channelAccessToken, userId, orderData);
        break;

      default:
        return createResponse(400, { error: 'Invalid action' });
    }

    return createResponse(200, result);

  } catch (error) {
    console.error('Error:', error);
    return createResponse(500, { error: error.message });
  }
}

/**
 * ç™¼é€ç´”æ–‡å­—è¨Šæ¯
 */
function pushTextMessage(token, userId, text) {
  const payload = {
    to: userId,
    messages: [{
      type: 'text',
      text: text
    }]
  };

  return callLinePushApi(token, payload);
}

/**
 * ç™¼é€ Flex Message
 */
function pushFlexMessage(token, userId, flexMessage) {
  const payload = {
    to: userId,
    messages: [flexMessage]
  };

  return callLinePushApi(token, payload);
}

/**
 * ç™¼é€è¨‚å–®å¡ç‰‡ï¼ˆæ¨™æº–åŒ–æ ¼å¼ï¼‰
 * @param {string} token - Channel Access Token
 * @param {string} userId - ä½¿ç”¨è€… LINE ID
 * @param {Object} orderData - è¨‚å–®è³‡æ–™
 */
function pushOrderCard(token, userId, orderData) {
  // å»ºç«‹è¨‚å–®é …ç›®åˆ—è¡¨
  const itemsList = orderData.items.map(item => ({
    type: 'box',
    layout: 'horizontal',
    contents: [
      {
        type: 'text',
        text: item.name,
        size: 'sm',
        color: '#555555',
        flex: 4
      },
      {
        type: 'text',
        text: `x${item.qty}`,
        size: 'sm',
        color: '#888888',
        flex: 1,
        align: 'center'
      },
      {
        type: 'text',
        text: `NT$ ${item.subtotal.toLocaleString()}`,
        size: 'sm',
        color: '#111111',
        flex: 2,
        align: 'end'
      }
    ]
  }));

  const flexMessage = {
    type: 'flex',
    altText: `ã€å¾é£›è—è¡“éŠ€è¡Œã€‘è¨‚å–®ç¢ºèª ${orderData.orderId}`,
    contents: {
      type: 'bubble',
      size: 'giga',
      header: {
        type: 'box',
        layout: 'vertical',
        contents: [
          {
            type: 'box',
            layout: 'horizontal',
            contents: [
              {
                type: 'text',
                text: 'å¾é£›è—è¡“éŠ€è¡Œ',
                weight: 'bold',
                color: '#ffffff',
                size: 'lg',
                flex: 4
              },
              {
                type: 'text',
                text: 'è¨‚å–®ç¢ºèª',
                color: '#ffffff',
                size: 'sm',
                flex: 2,
                align: 'end'
              }
            ]
          }
        ],
        backgroundColor: '#6d28d9',
        paddingAll: '20px'
      },
      body: {
        type: 'box',
        layout: 'vertical',
        contents: [
          // è¨‚å–®ç·¨è™Ÿ
          {
            type: 'box',
            layout: 'horizontal',
            contents: [
              {
                type: 'text',
                text: 'è¨‚å–®ç·¨è™Ÿ',
                size: 'xs',
                color: '#888888'
              },
              {
                type: 'text',
                text: orderData.orderId,
                size: 'sm',
                weight: 'bold',
                color: '#1d1d1f',
                align: 'end'
              }
            ],
            margin: 'none'
          },
          // åˆ†éš”ç·š
          {
            type: 'separator',
            margin: 'lg'
          },
          // å®¢æˆ¶è³‡è¨Šå€å¡Š
          {
            type: 'box',
            layout: 'vertical',
            margin: 'lg',
            contents: [
              {
                type: 'text',
                text: 'å®¢æˆ¶è³‡è¨Š',
                size: 'xs',
                color: '#888888',
                margin: 'none'
              },
              {
                type: 'text',
                text: orderData.customerName,
                size: 'md',
                weight: 'bold',
                margin: 'sm'
              },
              {
                type: 'text',
                text: orderData.customerPhone,
                size: 'sm',
                color: '#555555'
              }
            ]
          },
          // åˆ†éš”ç·š
          {
            type: 'separator',
            margin: 'lg'
          },
          // è¨‚è³¼é …ç›®
          {
            type: 'box',
            layout: 'vertical',
            margin: 'lg',
            contents: [
              {
                type: 'text',
                text: 'è¨‚è³¼é …ç›®',
                size: 'xs',
                color: '#888888',
                margin: 'none'
              },
              ...itemsList.map(item => ({
                ...item,
                margin: 'md'
              }))
            ]
          },
          // åˆ†éš”ç·š
          {
            type: 'separator',
            margin: 'lg'
          },
          // ç¸½é‡‘é¡
          {
            type: 'box',
            layout: 'horizontal',
            margin: 'lg',
            contents: [
              {
                type: 'text',
                text: 'ç¸½é‡‘é¡',
                size: 'md',
                weight: 'bold',
                color: '#1d1d1f'
              },
              {
                type: 'text',
                text: `NT$ ${orderData.total.toLocaleString()}`,
                size: 'xl',
                weight: 'bold',
                color: '#6d28d9',
                align: 'end'
              }
            ]
          },
          // æœå‹™é¡§å•
          {
            type: 'box',
            layout: 'horizontal',
            margin: 'lg',
            contents: [
              {
                type: 'text',
                text: 'æœå‹™é¡§å•',
                size: 'xs',
                color: '#888888'
              },
              {
                type: 'text',
                text: `${orderData.consultantName} (${orderData.consultantId})`,
                size: 'xs',
                color: '#888888',
                align: 'end'
              }
            ]
          }
        ],
        paddingAll: '20px'
      },
      footer: {
        type: 'box',
        layout: 'vertical',
        contents: [
          {
            type: 'text',
            text: 'ğŸ“± æ„Ÿè¬æ‚¨çš„è¨‚è³¼ï¼å¦‚æœ‰ä»»ä½•å•é¡Œè«‹éš¨æ™‚èˆ‡æˆ‘å€‘è¯ç¹«',
            size: 'xxs',
            color: '#888888',
            wrap: true,
            align: 'center'
          }
        ],
        backgroundColor: '#f5f5f7',
        paddingAll: '15px'
      }
    }
  };

  const payload = {
    to: userId,
    messages: [flexMessage]
  };

  return callLinePushApi(token, payload);
}

/**
 * å‘¼å« LINE Push API
 */
function callLinePushApi(token, payload) {
  const options = {
    method: 'post',
    contentType: 'application/json',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  const response = UrlFetchApp.fetch(LINE_PUSH_API, options);
  const responseCode = response.getResponseCode();
  const responseText = response.getContentText();

  if (responseCode === 200) {
    return { success: true, message: 'Message sent successfully' };
  } else {
    console.error('LINE API Error:', responseCode, responseText);
    return {
      success: false,
      error: `LINE API Error: ${responseCode}`,
      details: responseText
    };
  }
}

/**
 * å»ºç«‹ CORS å›æ‡‰
 */
function createResponse(statusCode, data) {
  const output = ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
  return output;
}

/**
 * è™•ç† GET è«‹æ±‚ï¼ˆç”¨æ–¼æ¸¬è©¦ï¼‰
 */
function doGet(e) {
  return createResponse(200, {
    status: 'ok',
    message: 'LINE Push API Proxy is running',
    usage: 'POST with { action: "pushOrderCard", userId: "...", orderData: {...} }'
  });
}
